<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è ‚Äî —Å –º—É–ª—å—Ç—Ñ–∏–ª—å–º–æ–º</title>
  <style>
    :root{--bg:#f3f7fb;--panel:#fff;--accent:#2b7cff;--muted:#6b7280}
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; margin:0; background:var(--bg); color:#071029; padding:18px}
    h1{font-size:20px;margin:0 0 12px}
    .panel{background:var(--panel);padding:12px;border-radius:10px;box-shadow:0 8px 20px rgba(12,20,40,0.06);margin-bottom:12px}
    input[type="text"], input[type="time"]{padding:8px;border-radius:8px;border:1px solid #e6e9ef}
    button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #d7e6ff;padding:6px 10px}
    .small{font-size:0.85em;color:var(--muted)}
    /* advice popup */
    #adviceAnimation{position:fixed;right:18px;bottom:18px;width:340px;max-width:calc(100% - 36px);background:rgba(255,255,255,0.98);border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(15,23,42,0.12);display:none;z-index:9999;align-items:center;gap:12px}
    #adviceAnimation.show{display:flex;animation:popupIn .32s ease-out}
    #adviceAnimation .icon{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:30px;background:#fff8;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
    #adviceAnimation .content{flex:1}
    #adviceAnimation .title{font-weight:700;margin-bottom:6px}
    #adviceAnimation .desc{font-size:13px;color:#333}
    @keyframes popupIn{from{transform:translateY(10px) scale(.98);opacity:0}to{transform:none;opacity:1}}
    /* cartoon full-screen stage */
    #cartoonStage { position: fixed; left: 0; top: 0; right: 0; bottom: 0; display: none; align-items: center; justify-content: center; background: rgba(6,10,23,0.5); z-index: 99999; }
    #cartoonStage.show { display:flex; }
    .stage-card { width: min(900px, 94%); max-width: 1100px; height: min(560px, 76vh); background: linear-gradient(180deg,#fefefe 0%, #f3f8ff 100%); border-radius: 14px; box-shadow: 0 20px 60px rgba(2,6,23,0.45); overflow: hidden; position: relative; display:flex; align-items:center; justify-content:center; padding:18px; }
    .scene { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:12px; opacity:0; transform:scale(.98); }
    .scene.show { opacity:1; transform:scale(1); transition: opacity .45s ease, transform .45s cubic-bezier(.2,.9,.3,1); }
    .sky { width:100%; height:220px; display:block; background:linear-gradient(180deg,#bde0ff,#e6f2ff); border-radius:10px; margin-bottom:6px; position:relative; overflow:hidden }
    .ground { width:100%; height:120px; background:linear-gradient(180deg,#7ad29f,#3da67a); border-radius:8px; position:relative; }
    .character { width:160px; height:200px; display:block; position:relative; }
    .char-body { width:100px; height:120px; background:#7aa2ff; border-radius:14px; position:absolute; left:30px; top:60px; box-shadow:inset 0 -6px 0 rgba(0,0,0,0.06) }
    .char-head { width:76px; height:76px; background:linear-gradient(180deg,#ffd9b3,#ffc899); border-radius:50%; position:absolute; left:42px; top:6px; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 12px rgba(0,0,0,0.06) }
    .eye { width:6px; height:6px; background:#111; border-radius:50%; position:absolute }
    .eye.left { left:22px; top:28px }
    .eye.right { right:22px; top:28px }
    .mouth { width:28px; height:8px; border-radius:8px; background:transparent; border-bottom:3px solid #111; position:absolute; bottom:14px; left:50%; transform:translateX(-50%); }
    .scarf { width:120px; height:18px; background:#ff8b8b; border-radius:8px; position:absolute; left:20px; top:120px }
    .cap { width:92px; height:32px; background:#f7c948; border-radius:14px; position:absolute; left:34px; top:-6px }
    .shiver { animation:shiverAnim .9s linear infinite; transform-origin:center; }
    @keyframes shiverAnim {0%{transform:translateY(0)}25%{transform:translateY(-6px) rotate(-1.2deg)}50%{transform:translateY(0)}75%{transform:translateY(4px) rotate(1.2deg)}100%{transform:translateY(0)}}
    .sun { position:absolute; right:18px; top:18px; width:110px; height:110px; border-radius:50%; background:radial-gradient(circle at 35% 30%, #fff7c6, #ffd166); box-shadow:0 12px 40px rgba(255,160,60,0.18); transform-origin:center; animation:sunPulse 1.1s ease-in-out infinite; }
    @keyframes sunPulse {0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
    .raindrop { width:8px; height:14px; background:#60a5fa; border-radius:4px; transform:rotate(20deg); animation:rainFall .65s linear infinite; opacity:.95 }
    @keyframes rainFall {0%{transform:translateY(-6px) rotate(20deg);opacity:1}50%{transform:translateY(10px) rotate(20deg);opacity:.7}100%{transform:translateY(-6px) rotate(20deg);opacity:1}}
    .speech-bubble { background:rgba(255,255,255,0.98); padding:10px 12px; border-radius:12px; box-shadow:0 8px 26px rgba(2,6,23,0.12); font-size:15px; max-width:560px; text-align:center }
    .timeline { position:absolute; left:12px; bottom:12px; display:flex; gap:6px; }
    .dot { width:8px;height:8px;border-radius:50%;background:#dbeafe;box-shadow:0 2px 6px rgba(2,6,23,0.06) }
    .dot.active { background:#2b7cff }
    .stage-close { position:absolute; right:12px; top:12px; background:transparent;border:0;color:#334155;font-size:20px;cursor:pointer; }
    @media (max-width:740px){ .character{width:120px;height:150px} .char-body{width:76px;height:100px;left:22px;top:50px} .char-head{width:62px;height:62px;left:29px;top:4px} }
  </style>
</head>
<body>
  <h1 data-i18n="title">–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</h1>

  <div class="panel">
    <label data-i18n="choose_language">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ (ru, en, uk, hu, fr):</label>
    <input id="langInput" type="text" value="ru" style="min-width:60px">
    <button id="startBtn" onclick="startApp()" data-i18n="start">–ù–∞—á–∞—Ç—å</button>
    <span class="small" id="ver">v1.0</span>
  </div>

  <div class="panel" id="statusPanel">
    <strong data-i18n="status_label">–°—Ç–∞—Ç—É—Å:</strong>
    <span id="status" class="small" data-i18n="status_not_started">–ù–µ –Ω–∞—á–∞—Ç–æ</span>
  </div>

  <div class="panel" id="weatherPanel">
    <strong data-i18n="weather_label">–ü–æ–≥–æ–¥–∞:</strong>
    <span id="weather">---</span>
  </div>

  <div class="panel" id="reminderPanel">
    <strong data-i18n="reminders_label">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:</strong>
    <div id="reminderList"><span class="small">---</span></div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <input id="reminderTime" type="time" style="min-width:120px">
      <input id="reminderText" type="text" placeholder="–¢–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è" style="flex:1">
      <button onclick="addReminder()" data-i18n="add_reminder">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <div class="panel" id="voicePanel">
    <strong data-i18n="voice_control">–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</strong>
    <span id="micState" class="small" style="margin-left:8px">–º–∏–∫—Ä–æ—Ñ–æ–Ω: –≤—ã–∫–ª</span>
    <div class="small" id="voiceHints">–ö–æ–º–∞–Ω–¥–∞: "–Ω–∞—á–∞—Ç—å", "—è–∑—ã–∫ ru", "–ø–æ–≥–æ–¥–∞", "–ø–æ–ª–∏—Ü–∏—è", "–Ω–∞–ø–æ–º–Ω–∏ –≤ 15:30 –ø–æ–∑–≤–æ–Ω–∏—Ç—å –º–∞–º–µ"</div>
    <button id="micToggle" style="margin-top:8px">–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
    <div id="recognized" class="small" style="margin-top:8px">---</div>
  </div>

  <div id="adviceAnimation" role="status" aria-live="polite">
    <div class="icon" id="adviceIcon">üß•</div>
    <div class="content">
      <div class="title" id="adviceTitle">–°–æ–≤–µ—Ç –ø–æ –æ–¥–µ–∂–¥–µ</div>
      <div class="desc" id="adviceDesc">–ï—Å–ª–∏ –Ω–µ –ø–æ—Å–ª—É—à–∞—Ç—å —Å–æ–≤–µ—Ç, –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è...</div>
    </div>
  </div>

  <div id="cartoonStage" aria-hidden="true" role="dialog" aria-live="polite">
    <div class="stage-card" role="document">
      <button class="stage-close" onclick="forceHideCartoon()" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>

      <div id="scene-cold" class="scene" aria-hidden="true">
        <div class="sky" style="width:90%;border-radius:10px;display:flex;align-items:center;justify-content:center">
          <div style="position:absolute;left:18px;top:18px;font-size:20px;color:#fff">‚ùÑÔ∏è</div>
          <div class="character shiver" aria-hidden="true">
            <div class="char-head"><div class="eye left"></div><div class="eye right"></div><div class="mouth" style="border-bottom-color:#111"></div></div>
            <div class="char-body"></div>
            <div class="scarf"></div>
          </div>
        </div>
        <div class="speech-bubble" id="bubble-cold">–í—ã –ø—Ä–æ–º—ë—Ä–∑–ª–∏ ‚Äî –Ω–∞–¥–µ–Ω—å—Ç–µ —Ç—ë–ø–ª—É—é –æ–¥–µ–∂–¥—É, –∏–Ω–∞—á–µ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç—ã—Ç—å.</div>
        <div class="timeline"><div class="dot active"></div><div class="dot"></div><div class="dot"></div></div>
      </div>

      <div id="scene-rain" class="scene" aria-hidden="true">
        <div class="sky" style="width:90%;border-radius:10px;display:flex;align-items:flex-start;justify-content:space-around;padding:14px">
          <div style="position:absolute;right:32px;top:12px"><div class="sun" style="display:none"></div></div>
          <div style="position:absolute;left:24px;top:18px;display:flex;flex-direction:column;gap:6px">
            <div class="raindrop" style="animation-delay:0ms"></div>
            <div class="raindrop" style="animation-delay:120ms"></div>
            <div class="raindrop" style="animation-delay:240ms"></div>
          </div>
          <div class="character" aria-hidden="true">
            <div class="char-head"><div class="eye left"></div><div class="eye right"></div><div class="mouth" style="border-bottom-color:#111"></div></div>
            <div class="char-body"></div>
            <div class="accessory" style="position:absolute;left:12px;top:120px"></div>
          </div>
        </div>
        <div class="speech-bubble" id="bubble-rain">–í–æ–∑–º–æ–∂–Ω–æ –¥–æ–∂–¥–ª–∏–≤–æ ‚Äî –≤–æ–∑—å–º–∏—Ç–µ –∫—É—Ä—Ç–∫—É –∏ –∑–æ–Ω—Ç–∏–∫.</div>
        <div class="timeline"><div class="dot"></div><div class="dot active"></div><div class="dot"></div></div>
      </div>

      <div id="scene-hot" class="scene" aria-hidden="true">
        <div class="sky" style="width:90%;border-radius:10px;display:flex;align-items:center;justify-content:center">
          <div class="sun" style="right:18px;top:18px"></div>
          <div class="character" aria-hidden="true">
            <div class="char-head"><div class="eye left"></div><div class="eye right"></div><div class="mouth" style="border-bottom-color:#111"></div></div>
            <div class="char-body"></div>
            <div class="cap" style="position:absolute;left:34px;top:-10px"></div>
          </div>
        </div>
        <div class="speech-bubble" id="bubble-hot">–ñ–∞—Ä–∫–æ ‚Äî –Ω–∞–¥–µ–Ω—å—Ç–µ –ª—ë–≥–∫—É—é –æ–¥–µ–∂–¥—É –∏ –≥–æ–ª–æ–≤–Ω–æ–π —É–±–æ—Ä, –ø–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã.</div>
        <div class="timeline"><div class="dot"></div><div class="dot"></div><div class="dot active"></div></div>
      </div>

    </div>
  </div>

<script>
/* –°–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π —Ñ–∞–π–ª:
   - –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (—á–∞—Å—Ç–∏—á–Ω–∞—è, –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—Ä–∞–∑—ã RU/EN)
   - –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è, –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–≥–æ–¥—ã (wttr.in)
   - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (localStorage)
   - TTS —Å onend callback, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –º—É–ª—å—Ç—Ñ–∏–ª—å–º–∞ –ø–æ—Å–ª–µ —Ä–µ—á–∏
   - –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –º—É–ª—å—Ç—Ñ–∏–ª—å–º (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ü–µ–Ω), –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –∫–ª–∏–∫–æ–≤
   - –±–∞–∑–æ–≤–æ–µ STT (–≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞) –∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ)
*/

/* ========== i18n ========== */
let langCode = 'ru';
const i18n = {
  ru: {
    title:"–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è", choose_language:"–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ (ru, en, uk, hu, fr):", start:"–ù–∞—á–∞—Ç—å",
    status_not_started:"–ù–µ –Ω–∞—á–∞—Ç–æ", locating:"–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...", location_failed:"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.",
    your_country:(c)=>`–í–∞—à–∞ —Å—Ç—Ä–∞–Ω–∞: ${c}`, weather_label:"–ü–æ–≥–æ–¥–∞:", reminders_label:"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:", add_reminder:"–î–æ–±–∞–≤–∏—Ç—å",
    clothing_advice_label:"–°–æ–≤–µ—Ç –ø–æ –æ–¥–µ–∂–¥–µ:", reminder_set:(t,task)=>`–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ ${t}: ${task}`,
    reminder_fire:(task,t,d)=>`–ù–∞–ø–æ–º–∏–Ω–∞—é: ${task}. –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ${t}¬∞C, –ø–æ–≥–æ–¥–∞: ${d}.`, temp_weather_tts:(t,d)=>`–°–µ–π—á–∞—Å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ${t} –≥—Ä–∞–¥—É—Å–æ–≤, ${d}`
  },
  en: {
    title:"Emergency services and reminders", choose_language:"Choose language (ru, en, uk, hu, fr):", start:"Start",
    status_not_started:"Not started", locating:"Detecting location...", location_failed:"Failed to determine location.",
    your_country:(c)=>`Your country: ${c}`, weather_label:"Weather:", reminders_label:"Reminders:", add_reminder:"Add",
    clothing_advice_label:"Clothing advice:", reminder_set:(t,task)=>`Reminder set at ${t}: ${task}`,
    reminder_fire:(task,t,d)=>`Reminder: ${task}. Temperature ${t}¬∞C, weather: ${d}.`, temp_weather_tts:(t,d)=>`Current temperature ${t} degrees, ${d}`
  }
};
function tt(key,...args){ const b = i18n[langCode] || i18n.ru; const v = b[key]; return typeof v === 'function' ? v(...args) : (v ?? (typeof i18n.ru[key] === 'function' ? i18n.ru[key](...args) : i18n.ru[key])); }

/* ========== utils ========== */
function mapLangToBCP47(l){ switch((l||'ru').toLowerCase()){case 'ru':return 'ru-RU';case 'en':return 'en-US';case 'uk':return 'uk-UA';case 'hu':return 'hu-HU';case 'fr':return 'fr-FR';default:return 'ru-RU'} }

/* ========== TTS ========== */
function speakWithCallback(text, lang, onEnd){
  try{
    if(!('speechSynthesis' in window)){ if(typeof onEnd==='function') setTimeout(onEnd,700); return; }
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = mapLangToBCP47(lang);
    u.onend = ()=>{ if(typeof onEnd === 'function') onEnd(); };
    u.onerror = ()=>{ if(typeof onEnd === 'function') onEnd(); };
    speechSynthesis.speak(u);
  }catch(e){ console.warn('TTS', e); if(typeof onEnd==='function') setTimeout(onEnd,700); }
}

/* ========== Weather (wttr.in) ========== */
async function getWeather(lat, lon){
  try{
    const url = `https://wttr.in/${lat},${lon}?format=j1`;
    const res = await fetch(url);
    const data = await res.json();
    const cur = data.current_condition && data.current_condition[0];
    if(!cur) return null;
    return { temp: Number(cur.temp_C), desc: cur.weatherDesc?.[0]?.value || '' };
  }catch(e){ console.warn('getWeather', e); return null; }
}

/* ========== Geolocation ========== */
async function getLocation(){
  return new Promise(resolve=>{
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(p=>resolve({lat:p.coords.latitude, lon:p.coords.longitude}), e=>{ console.warn(e); resolve(null); }, { timeout:10000 });
    } else resolve(null);
  });
}

/* ========== Reminders ========== */
let reminders = [];
const STORAGE_KEY = 'cartoon_reminders_v1';
function loadReminders(){ try{ const raw = localStorage.getItem(STORAGE_KEY); reminders = raw ? JSON.parse(raw) : []; }catch(e){ reminders = []; } displayReminders(); reminders.forEach(r => { if(!r.spoken) scheduleReminderCheck(r); }); }
function saveReminders(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(reminders)); }

function addReminder(){
  const time = document.getElementById('reminderTime').value;
  const task = document.getElementById('reminderText').value.trim();
  if(!time || !task) return alert((langCode==='en') ? 'Enter time and text' : '–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –∏ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è');
  if(!lastLocation) return alert(tt('locating'));
  const id = Date.now() + Math.random();
  const rem = { id, time, task, lat:lastLocation.lat, lon:lastLocation.lon, spoken:false };
  reminders.push(rem); saveReminders(); displayReminders(); scheduleReminderCheck(rem);
  document.getElementById('reminderTime').value = ''; document.getElementById('reminderText').value = '';
  speakWithCallback(tt('reminder_set', time, task), langCode, null);
}

function displayReminders(){
  const c = document.getElementById('reminderList');
  if(!reminders.length){ c.innerHTML = '<span class="small">---</span>'; return; }
  c.innerHTML = '';
  reminders.forEach(r=>{
    const el = document.createElement('div'); el.className = 'reminder-item';
    el.innerHTML = `<div><strong>${r.time}</strong> <span class="reminder-text">${r.task}</span></div>`;
    const del = document.createElement('button'); del.textContent='–£–¥–∞–ª–∏—Ç—å'; del.className='ghost'; del.onclick = ()=>{ reminders = reminders.filter(x=>x.id!==r.id); saveReminders(); displayReminders(); };
    el.appendChild(del); c.appendChild(el);
  });
}

/* schedule check */
function scheduleReminderCheck(reminder){
  const timer = setInterval(async ()=>{
    const now = new Date(); const hh = String(now.getHours()).padStart(2,'0'); const mm = String(now.getMinutes()).padStart(2,'0');
    if(`${hh}:${mm}` === reminder.time && !reminder.spoken){
      clearInterval(timer);
      reminder.spoken = true; saveReminders();
      const weather = await getWeather(reminder.lat, reminder.lon);
      let text = tt('reminder_set', reminder.time, reminder.task);
      if(weather) text = tt('reminder_fire', reminder.task, weather.temp, weather.desc);
      // show compact advice popup
      showAdvicePopup(weather?.temp, chooseClothingAdvice(weather?.temp));
      // speak and then show cartoon automatically
      speakWithCallback(text, langCode, ()=>{ try{ showFullCartoon(weather ? weather.temp : null); }catch(e){ console.warn(e); } });
      // remove from display list
      reminders = reminders.filter(r=>r.id !== reminder.id); saveReminders(); displayReminders();
    }
  }, 12*1000);
}

/* ========== Clothing advice (multi-lang simple) ========== */
const CLOTHING = {
  ru: { very_cold:"–û—á–µ–Ω—å —Ö–æ–ª–æ–¥–Ω–æ ‚Äî –Ω–∞–¥–µ–Ω—å—Ç–µ —Ç—ë–ø–ª—É—é –∫—É—Ä—Ç–∫—É, —à–∞—Ä—Ñ –∏ –ø–µ—Ä—á–∞—Ç–∫–∏.", cold:"–•–æ–ª–æ–¥–Ω–æ ‚Äî –º–æ–∂–Ω–æ –Ω–∞–¥–µ—Ç—å —Å–≤–∏—Ç–µ—Ä –∏–ª–∏ –ª—ë–≥–∫—É—é –∫—É—Ä—Ç–∫—É.", cool:"–ü—Ä–æ—Ö–ª–∞–¥–Ω–æ ‚Äî –≤–æ–∑—å–º–∏—Ç–µ –≤–µ—Ç—Ä–æ–≤–∫—É –∏–ª–∏ –ª—ë–≥–∫—É—é –∫—É—Ä—Ç–∫—É.", warm:"–¢—ë–ø–ª–æ ‚Äî –º–æ–∂–Ω–æ –Ω–∞–¥–µ—Ç—å —Ñ—É—Ç–±–æ–ª–∫—É, –≤–æ–∑–º–æ–∂–Ω–æ –∫–µ–ø–∫—É.", hot:"–ñ–∞—Ä–∫–æ ‚Äî –Ω–∞–¥–µ–Ω—å—Ç–µ –ª—ë–≥–∫—É—é –æ–¥–µ–∂–¥—É –∏ –∫–µ–ø–∫—É, –ø–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã." },
  en: { very_cold:"Very cold ‚Äî wear a warm coat, scarf and gloves.", cold:"Cold ‚Äî you can wear a sweater or light jacket.", cool:"Cool ‚Äî take a light jacket.", warm:"Warm ‚Äî a t-shirt is fine, consider a cap.", hot:"Hot ‚Äî wear light clothing and a cap, stay hydrated." }
};
function chooseClothingAdvice(tempC){
  const t = Number(tempC);
  const dict = CLOTHING[langCode] || CLOTHING.ru;
  if(isNaN(t)) return '';
  if(t<=5) return dict.very_cold;
  if(t<=15) return dict.cold;
  if(t<=22) return dict.cool;
  if(t<=30) return dict.warm;
  return dict.hot;
}

/* ========== Advice popup & cartoon ========== */
let adviceHideTimer = null;
function showAdvicePopup(temp, adviceText){
  const pop = document.getElementById('adviceAnimation');
  const icon = document.getElementById('adviceIcon');
  const title = document.getElementById('adviceTitle');
  const desc = document.getElementById('adviceDesc');
  title.textContent = tt('clothing_advice_label');
  desc.textContent = adviceText || '';
  const icons = {very_cold:'ü•∂', cold:'üß•', cool:'üå¨Ô∏è', warm:'üß¢', hot:'‚òÄÔ∏è'};
  icon.textContent = icons[getTempCategory(temp)] || '‚ÑπÔ∏è';
  pop.classList.add('show');
  if(adviceHideTimer) clearTimeout(adviceHideTimer);
  adviceHideTimer = setTimeout(()=>pop.classList.remove('show'),6000);
}

function getTempCategory(tempC){
  const t = Number(tempC);
  if(isNaN(t)) return 'cool';
  if(t<=5) return 'very_cold';
  if(t<=15) return 'cold';
  if(t<=22) return 'cool';
  if(t<=30) return 'warm';
  return 'hot';
}

/* Cartoon timeline */
let cartoonTimers = [];
function clearCartoonTimers(){ cartoonTimers.forEach(h=>clearTimeout(h)); cartoonTimers = []; }
function showFullCartoon(tempC){
  clearCartoonTimers();
  const t = typeof tempC === 'number' ? tempC : (tempC ? Number(tempC) : NaN);
  let category = 'cool';
  if(!isNaN(t)){
    if(t<=5) category = 'very_cold';
    else if(t<=15) category = 'cold';
    else if(t<=22) category = 'cool';
    else if(t<=30) category = 'warm';
    else category = 'hot';
  }

  const stage = document.getElementById('cartoonStage');
  stage.classList.add('show'); stage.setAttribute('aria-hidden','false');

  // hide all scenes
  ['scene-cold','scene-rain','scene-hot'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); } });

  // sequence decision
  let sequence = [];
  if(category === 'very_cold' || category === 'cold') sequence = ['scene-cold'];
  else if(category === 'cool') sequence = ['scene-rain'];
  else sequence = ['scene-hot'];

  const sceneDuration = 2200;
  const gap = 300;
  let offset = 0;

  sequence.forEach((sceneId, idx)=>{
    cartoonTimers.push(setTimeout(()=>{ const el=document.getElementById(sceneId); if(el){ // populate localized bubble
      const bubble = el.querySelector('.speech-bubble');
      if(bubble){
        if(sceneId==='scene-cold') bubble.textContent = (langCode==='en') ? 'You are cold ‚Äî wear warm clothes or you may catch a cold.' : '–í—ã –ø—Ä–æ–º—ë—Ä–∑–ª–∏ ‚Äî –Ω–∞–¥–µ–Ω—å—Ç–µ —Ç—ë–ø–ª—É—é –æ–¥–µ–∂–¥—É, –∏–Ω–∞—á–µ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç—ã—Ç—å.';
        if(sceneId==='scene-rain') bubble.textContent = (langCode==='en') ? 'It may rain ‚Äî take a jacket and umbrella.' : '–í–æ–∑–º–æ–∂–Ω–æ –¥–æ–∂–¥–ª–∏–≤–æ ‚Äî –≤–æ–∑—å–º–∏—Ç–µ –∫—É—Ä—Ç–∫—É –∏ –∑–æ–Ω—Ç–∏–∫.';
        if(sceneId==='scene-hot') bubble.textContent = (langCode==='en') ? 'It is hot ‚Äî wear light clothes and a hat, stay hydrated.' : '–ñ–∞—Ä–∫–æ ‚Äî –Ω–∞–¥–µ–Ω—å—Ç–µ –ª—ë–≥–∫—É—é –æ–¥–µ–∂–¥—É –∏ –≥–æ–ª–æ–≤–Ω–æ–π —É–±–æ—Ä, –ø–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã.';
      }
      el.classList.add('show'); el.setAttribute('aria-hidden','false'); } }), offset);
    // small visual beat inside scene
    cartoonTimers.push(setTimeout(()=>{ if(sceneId==='scene-cold'){ const b = document.querySelector(`#${sceneId} .speech-bubble`); if(b){ b.style.transform='translateY(-6px)'; b.style.transition='transform 220ms ease'; setTimeout(()=>b.style.transform='',520); } } }, offset + 400));
    // hide later
    cartoonTimers.push(setTimeout(()=>{ const el=document.getElementById(sceneId); if(el){ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); } }, offset + sceneDuration));
    offset += sceneDuration + gap;
  });

  // final summary and hide
  cartoonTimers.push(setTimeout(()=>{ const card=document.querySelector('.stage-card'); const summary=document.createElement('div'); summary.className='speech-bubble'; summary.style.position='absolute'; summary.style.left='50%'; summary.style.top='50%'; summary.style.transform='translate(-50%,-50%) scale(.98)'; summary.style.zIndex=3; summary.style.fontWeight=700; summary.textContent = (langCode==='en') ? 'Take care! Follow the advice.' : '–ë—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã! –°–ª–µ–¥—É–π—Ç–µ —Å–æ–≤–µ—Ç—É.'; card.appendChild(summary); setTimeout(()=>{ summary.style.transition='opacity .45s ease'; summary.style.opacity=0; setTimeout(()=>{ if(summary.parentNode) summary.parentNode.removeChild(summary); },500); },900); }, offset + 120));
  cartoonTimers.push(setTimeout(()=>{ hideCartoonStage(); clearCartoonTimers(); }, offset + 1500));
}

function forceHideCartoon(){ hideCartoonStage(); clearCartoonTimers(); }
function hideCartoonStage(){ const stage=document.getElementById('cartoonStage'); stage.classList.remove('show'); stage.setAttribute('aria-hidden','true'); ['scene-cold','scene-rain','scene-hot'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); } }); }

/* ========== Basic STT (toggle) ========== */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null; let isListening = false;
function ensureRecognition(){
  if(!SpeechRecognition) return null;
  if(recognition) return recognition;
  recognition = new SpeechRecognition();
  recognition.continuous = true; recognition.interimResults = false;
  recognition.lang = mapLangToBCP47(langCode);
  recognition.onresult = (ev)=>{ const last = ev.results[ev.results.length-1]; if(!last) return; const text = (last[0]?.transcript||'').trim(); if(!text) return; document.getElementById('recognized').innerText = `–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: ${text}`; handleVoiceCommand(text.toLowerCase()); };
  recognition.onstart = ()=> updateMicState(true);
  recognition.onend = ()=> updateMicState(false);
  recognition.onerror = ()=> updateMicState(false);
  return recognition;
}
function updateMicState(on){ isListening = !!on; document.getElementById('micState').textContent = on ? (langCode==='en' ? 'microphone: on' : '–º–∏–∫—Ä–æ—Ñ–æ–Ω: –≤–∫–ª') : (langCode==='en' ? 'microphone: off' : '–º–∏–∫—Ä–æ—Ñ–æ–Ω: –≤—ã–∫–ª'); document.getElementById('micToggle').textContent = on ? (langCode==='en' ? 'Turn off mic' : '–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω') : (langCode==='en' ? 'Turn on mic' : '–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω'); }
function startListening(){ const r=ensureRecognition(); if(!r){ document.getElementById('recognized').innerText = (langCode==='en'?'Your browser has no STT':'–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏.'); return; } try{ r.lang = mapLangToBCP47(langCode); r.start(); }catch(e){} }
function stopListening(){ if(!recognition) return; try{ recognition.stop(); }catch(e){} }
document.getElementById('micToggle').addEventListener('click', ()=>{ if(isListening) stopListening(); else startListening(); });

/* Minimal voice command handling (start, language change, reminder short form, weather) */
const voicePatterns = {
  ru: { startKeywords:['–Ω–∞—á–∞—Ç—å','—Å—Ç–∞—Ä—Ç'], langRegex:/\b—è–∑—ã–∫\s+(ru|en|uk|hu|fr)\b/, remind:/\b–Ω–∞–ø–æ–º–Ω–∏\s+(?:–≤|–Ω–∞)\s+(\d{1,2}[:\.]\d{2})\s+(.+)/, weatherKeywords:['–ø–æ–≥–æ–¥–∞'] },
  en: { startKeywords:['start','begin'], langRegex:/\blanguage\s+(ru|en|uk|hu|fr)\b/, remind:/\bremind\s+(?:at|for)\s+(\d{1,2}[:\.]\d{2})\s+(.+)/, weatherKeywords:['weather'] }
};
function handleVoiceCommand(text){
  const p = voicePatterns[langCode] || voicePatterns.ru;
  if(p.startKeywords.some(k=>text.includes(k))){ startApp(); return; }
  const lm = text.match(p.langRegex); if(lm){ setLanguage(lm[1]); document.getElementById('langInput').value = langCode; speakWithCallback((langCode==='en'?'Language set':'–Ø–∑—ã–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω') + ': ' + langCode, langCode, null); return; }
  if(p.weatherKeywords.some(k=>text.includes(k))){ if(lastLocation){ getWeather(lastLocation.lat,lastLocation.lon).then(w=>{ if(w){ document.getElementById('weather').innerText = `–ü–æ–≥–æ–¥–∞: ${w.temp}¬∞C, ${w.desc}`; speakWithCallback(tt('temp_weather_tts', w.temp, w.desc), langCode, null); } }); } else speakWithCallback(tt('locating'), langCode, null); return; }
  const rm = text.match(p.remind); if(rm){ const time = rm[1].replace('.',':'); const task = rm[2].trim(); if(lastLocation){ const id = Date.now()+Math.random(); const r={id,time,task,lat:lastLocation.lat,lon:lastLocation.lon,spoken:false}; reminders.push(r); saveReminders(); displayReminders(); scheduleReminderCheck(r); speakWithCallback(tt('reminder_set', time, task), langCode, null); } else speakWithCallback(tt('locating'), langCode, null); return; }
}

/* ========== Start app & init ========== */
let lastLocation = null;
async function startApp(){
  document.getElementById('status').innerText = tt('locating');
  const loc = await getLocation();
  if(!loc){ document.getElementById('status').innerText = tt('location_failed'); speakWithCallback(tt('location_failed'), langCode, null); return; }
  lastLocation = loc;
  document.getElementById('status').innerText = (langCode==='en') ? 'Location set' : '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
  const w = await getWeather(loc.lat, loc.lon);
  if(w){ document.getElementById('weather').innerText = `–ü–æ–≥–æ–¥–∞: ${w.temp}¬∞C, ${w.desc}`; speakWithCallback(tt('temp_weather_tts', w.temp, w.desc), langCode, null); }
}

/* init */
document.getElementById('langInput').addEventListener('input',(e)=>{ langCode = (e.target.value||'ru').toLowerCase(); });
loadReminders();

/* expose helpers */
window.showFullCartoon = showFullCartoon;
window.forceHideCartoon = forceHideCartoon;
window.getWeather = getWeather;

</script>
</body>
</html>
