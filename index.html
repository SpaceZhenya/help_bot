
<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<title>Экстренные службы и напоминания</title>
	<style>
		body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
		.panel { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
		button { margin: 5px 0; padding: 10px 15px; }
		.status { color: #555; font-size: 0.9em; }
		.badge { display: inline-block; padding: 2px 6px; border-radius: 6px; font-size: 12px; background: #eee; margin-left: 6px; }
		.badge.on { background: #dff6dd; color: #1a7f37; }
		.badge.off { background: #ffe2e2; color: #a40000; }
		#recognized { display: block; margin-top: 8px; color: #333; }
	</style>
</head>
<body>
	<h1 data-i18n="title">Экстренные службы и напоминания</h1>

	<div class="panel">
		<label data-i18n="choose_language">Выберите язык (ru, en, uk, hu, fr): </label>
		<input type="text" id="langInput" value="ru">
		<button id="startBtn" onclick="startApp()" data-i18n="start">Начать</button>
	</div>

	<div class="panel" id="statusPanel">
		<strong data-i18n="status_label">Статус:</strong> <span id="status" data-i18n="status_not_started">Не начато</span>
	</div>

	<div class="panel" id="weatherPanel">
		<strong data-i18n="weather_label">Погода:</strong> <span id="weather">---</span>
	</div>

	<div class="panel" id="reminderPanel">
		<strong data-i18n="reminders_label">Напоминания:</strong> <span id="reminder">---</span>
	</div>

	<div class="panel" id="emergencyPanel">
		<strong data-i18n="emergency_actions">Экстренные действия:</strong><br>
		<button id="btnSound" onclick="emergencySoundDetection(currentCountry, langCode)" data-i18n="check_sound">Проверить звук</button>
		<button id="btnPolice" onclick="emergencyCall(currentCountry, 'полиция', langCode)" data-i18n="police">Полиция</button>
		<button id="btnFire" onclick="emergencyCall(currentCountry, 'пожарная', langCode)" data-i18n="fire">Пожарная</button>
		<button id="btnAmbulance" onclick="emergencyCall(currentCountry, 'скорая', langCode)" data-i18n="ambulance">Скорая</button>
	</div>

	<div class="panel" id="voicePanel">
		<strong data-i18n="voice_control">Голосовое управление</strong>
		<span id="micState" class="badge off">микрофон: выкл</span>
		<div class="status" id="voiceHints" data-i18n="voice_examples">Команда примеры: "начать", "язык ru", "погода", "полиция", "напомни в 15:30 позвонить маме"</div>
		<button id="micToggle">Включить микрофон</button>
		<span id="recognized">---</span>
	</div>

	<script>
	// ===== i18n (translations) =====
	let langCode = "ru";
	const i18n = { /* ...твой объект переводов (ru, en, uk, hu, fr) как в оригинале... */ };

	// ===== Командные паттерны по языкам =====
	const commandPatterns = { /* ...как в оригинале... */ };

	// ===== Ключевые слова для распознавания звуков =====
	const soundKeywords = { /* ...как в оригинале... */ };

	// ===== Экстренные номера =====
	const emergencyNumbers = { /* ...как в оригинале... */ };

	// ===== Алиасы стран и нормализация =====
	const countryAliases = { /* ...как в оригинале... */ };

	function normalizeCountryName(name) {
		if (!name) return "Неизвестно";
		if (emergencyNumbers[name]) return name;
		const key = String(name).toLowerCase().trim().replace(/\./g, "");
		if (countryAliases[key]) return countryAliases[key];
		const foundAlias = Object.keys(countryAliases).find(alias => key.includes(alias));
		if (foundAlias) return countryAliases[foundAlias];
		return name;
	}

	// ===== Добавляем переводы стран =====
	const countryTranslations = {
		"Россия": { ru:"Россия", en:"Russia", uk:"Росія", hu:"Oroszország", fr:"Russie" },
		"США": { ru:"США", en:"USA", uk:"США", hu:"USA", fr:"États-Unis" },
		"Украина": { ru:"Украина", en:"Ukraine", uk:"Україна", hu:"Ukrajna", fr:"Ukraine" },
		"Венгрия": { ru:"Венгрия", en:"Hungary", uk:"Угорщина", hu:"Magyarország", fr:"Hongrie" },
		"Франция": { ru:"Франция", en:"France", uk:"Франція", hu:"Franciaország", fr:"France" }
	};

	function translateCountry(name, lang) {
		if (!name) return "Неизвестно";
		return (countryTranslations[name] && countryTranslations[name][lang]) || name;
	}

	// ===== Языковые коды для TTS/STT =====
	function mapLangToBCP47(lang) { /* ...как в оригинале... */ }

	// ===== Функция озвучки =====
	function speak(text, lang) { /* ...как в оригинале... */ }

	// ===== Получение геопозиции =====
	async function getLocation() { /* ...как в оригинале... */ }

	// ===== Получение погоды =====
	async function getWeather(lat, lon) { /* ...как в оригинале... */ }

	function startWeatherAutoRefresh(lat, lon) { /* ...как в оригинале... */ }

	async function getCountry(lat, lon) {
		try {
			const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
			const data = await res.json();
			const raw = data.address.country || "Неизвестно";
			const normalized = normalizeCountryName(raw);
			return normalized || raw;
		} catch(e) {
			return "Неизвестно";
		}
	}

	function emergencySoundDetection(country, lang) { /* ...как в оригинале... */ }

	function emergencyCall(country, service, lang) { /* ...как в оригинале... */ }

	function setReminder(reminderTime, task, lat, lon, lang) { /* ...как в оригинале... */ }

	const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
	let recognition = null;
	let isListening = false;

	function ensureRecognition() { /* ...как в оригинале... */ }

	function updateMicBadge(on) { /* ...как в оригинале... */ }

	function startListening() { /* ...как в оригинале... */ }

	function stopListening() { /* ...как в оригинале... */ }

	document.getElementById("micToggle").addEventListener("click", () => {
		if (isListening) stopListening(); else startListening();
	});

	function handleVoiceCommand(originalText) {
		const text = originalText.toLowerCase();
		const patterns = commandPatterns[langCode] || commandPatterns.ru;

		if (patterns.stopKeywords.some(k => text.includes(k))) { stopListening(); return; }
		if (patterns.startKeywords.some(k => text.includes(k))) { startApp(); return; }

		const langMatch = text.match(patterns.langRegex);
		if (langMatch) { setLanguage(langMatch[1]); document.getElementById("langInput").value = langCode; speak(tt('lang_set', langCode), langCode); return; }

		if (patterns.weatherKeywords.some(k => text.includes(k))) {
			if (lastLocation) {
				getWeather(lastLocation.lat, lastLocation.lon).then(w => {
					if (w) { document.getElementById("weather").innerText = tt('weather_text', w.temp, w.desc); speak(tt('now_weather_tts', w.temp, w.desc), langCode); }
				});
			} else { speak(tt('say_start_first'), langCode); }
			return;
		}

		const countrySetMatch = text.match(patterns.countryRegex);
		if (countrySetMatch) {
			const candidate = countrySetMatch[1].trim();
			currentCountry = normalizeCountryName(candidate);
			document.getElementById("status").innerText = tt('your_country', translateCountry(currentCountry, langCode));
			speak(tt('country_set', translateCountry(currentCountry, langCode)), langCode);
			return;
		}

		for (const svc of patterns.services) {
			if (svc.keywords.some(k => text.includes(k))) {
				emergencyCall(currentCountry, svc.service, langCode);
				return;
			}
		}

		const remindMatch = text.match(patterns.reminderRegex);
		if (remindMatch) {
			const rawTime = remindMatch[1].replace('.', ':');
			const task = remindMatch[2].trim();
			if (lastLocation) {
				setReminder(rawTime, task, lastLocation.lat, lastLocation.lon, langCode);
				document.getElementById("reminder").innerText = tt('reminder_set', rawTime, task);
				speak(tt('reminder_set', rawTime, task), langCode);
			} else {
				speak(tt('say_start_first'), langCode);
			}
			return;
		}
	}

	let lastLocation = null;

	async function startApp() {
		langCode = document.getElementById("langInput").value || "ru";
		setLanguage(langCode);
		document.getElementById("status").innerText = tt('locating');
		const loc = await getLocation();
		if (!loc) { speak(tt('location_failed'), langCode); return; }

		lastLocation = loc;
		currentCountry = await getCountry(loc.lat, loc.lon);
		document.getElementById("status").innerText = tt('your_country', translateCountry(currentCountry, langCode));

		const weather = await getWeather(loc.lat, loc.lon);
		if (weather) { document.getElementById("weather").innerText = tt('weather_text', weather.temp, weather.desc); speak(tt('temp_weather_tts', weather.temp, weather.desc), langCode); }

		startWeatherAutoRefresh(loc.lat, loc.lon);
	}

	document.getElementById("langInput").addEventListener("input", (e) => { setLanguage(e.target.value); });
	applyStaticTranslations();
	</script>
</body>
</html>


