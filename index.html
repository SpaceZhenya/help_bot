<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</title>
  <style>
    :root{--bg:#f3f6fb;--panel:#fff;--accent:#2b7cff;--muted:#666;}
    html,body{height:100%} body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; margin:0; background:var(--bg); padding:20px; color:#071029}
    h1{margin:0 0 12px;font-size:20px}
    .panel{background:var(--panel);padding:14px;border-radius:10px;box-shadow:0 8px 28px rgba(12,20,40,0.06);margin-bottom:14px}
    label{margin-right:8px}
    input[type="text"], input[type="time"]{padding:8px;border-radius:8px;border:1px solid #e6e9ef}
    button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #d7e6ff}
    .status{color:var(--muted);font-size:0.95em}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eee;font-size:12px;margin-left:8px}
    .badge.on{background:#dff6dd;color:#1a7f37}
    .badge.off{background:#ffe2e2;color:#a40000}
    #reminderList{margin-top:10px}
    .reminder-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:#fafafa;margin-bottom:8px}
    .reminder-text{margin-left:8px;flex:1}
    .small{font-size:0.85em;color:#667085}
    /* advice popup */
    #adviceAnimation{position:fixed;right:18px;bottom:18px;width:340px;max-width:calc(100% - 36px);background:rgba(255,255,255,0.98);border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(15,23,42,0.12);display:none;z-index:9999;align-items:center;gap:12px}
    #adviceAnimation.show{display:flex;animation:popupIn .32s ease-out}
    #adviceAnimation .icon{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:30px;background:#fff8;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
    #adviceAnimation .content{flex:1}
    #adviceAnimation .title{font-weight:700;margin-bottom:6px}
    #adviceAnimation .desc{font-size:13px;color:#333}
    @keyframes popupIn{from{transform:translateY(10px) scale(.98);opacity:0}to{transform:none;opacity:1}}
    /* cartoon popup */
    #cartoonPopup{position:fixed;right:18px;bottom:18px;width:360px;max-width:calc(100% - 36px);background:linear-gradient(180deg,#fff,#f7fbff);border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(15,23,42,0.12);display:none;z-index:9999;overflow:hidden}
    #cartoonPopup.show{display:block;animation:popupIn .28s ease-out}
    .cartoon-row{display:flex;gap:12px;align-items:center}
    .cartoon-svg{width:120px;height:120px;flex:0 0 120px}
    .consequence-badge{margin-top:8px;display:block;font-size:13px;color:#374151;background:#f8fafc;padding:8px;border-radius:8px}
    .closeBtn{background:transparent;border:0;font-size:18px;color:#6b7280;cursor:pointer}
    /* animations */
    .shiver{animation:shiverAnim 900ms linear infinite}
    @keyframes shiverAnim{0%{transform:translateY(0)}25%{transform:translateY(-4px) rotate(-1deg)}50%{transform:translateY(0)}75%{transform:translateY(3px) rotate(1deg)}100%{transform:translateY(0)}}
    .sunPulse{animation:sunPulse 1000ms ease-in-out infinite}
    @keyframes sunPulse{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
    .rainDrop{animation:rainFall 700ms linear infinite}
    @keyframes rainFall{0%{transform:translateY(-2px);opacity:1}50%{transform:translateY(6px);opacity:.7}100%{transform:translateY(-2px);opacity:1}}
    .sneeze{opacity:0;animation:sneezePop 1200ms ease-in-out forwards}
    @keyframes sneezePop{0%{opacity:0;transform:translateX(0) scale(.8)}30%{opacity:1;transform:translateX(6px) scale(1.02)}70%{opacity:1;transform:translateX(12px) scale(1)}100%{opacity:0;transform:translateX(18px) scale(.9)}}
    @media (max-width:420px){#adviceAnimation{right:10px;left:10px;bottom:12px;padding:10px}#cartoonPopup{right:10px;left:10px;bottom:12px;padding:10px}.cartoon-svg{width:96px;height:96px;flex:0 0 96px}}
  </style>
</head>
<body>
  <h1 data-i18n="title">–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</h1>

  <div class="panel">
    <label data-i18n="choose_language">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ (ru, en, uk, hu, fr):</label>
    <input id="langInput" type="text" value="ru" style="min-width:60px">
    <button id="startBtn" onclick="startApp()" data-i18n="start">–ù–∞—á–∞—Ç—å</button>
    <span class="small" style="margin-left:12px" id="versionInfo">v1.0</span>
  </div>

  <div class="panel" id="statusPanel">
    <strong data-i18n="status_label">–°—Ç–∞—Ç—É—Å:</strong>
    <span id="status" class="status" data-i18n="status_not_started">–ù–µ –Ω–∞—á–∞—Ç–æ</span>
  </div>

  <div class="panel" id="weatherPanel">
    <strong data-i18n="weather_label">–ü–æ–≥–æ–¥–∞:</strong>
    <span id="weather">---</span>
  </div>

  <div class="panel" id="reminderPanel">
    <strong data-i18n="reminders_label">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:</strong>
    <div id="reminderList"><span class="small">---</span></div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <input id="reminderTime" type="time" style="min-width:120px">
      <input id="reminderText" type="text" placeholder="–¢–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è" style="flex:1">
      <button onclick="addReminder()" data-i18n="add_reminder">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <div class="panel" id="emergencyPanel">
    <strong data-i18n="emergency_actions">–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:</strong><br>
    <button id="btnSound" onclick="emergencySoundDetection(currentCountry)" data-i18n="check_sound">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–≤—É–∫</button>
    <button id="btnPolice" onclick="emergencyCall(currentCountry,'–ø–æ–ª–∏—Ü–∏—è')" data-i18n="police">–ü–æ–ª–∏—Ü–∏—è</button>
    <button id="btnFire" onclick="emergencyCall(currentCountry,'–ø–æ–∂–∞—Ä–Ω–∞—è')" data-i18n="fire">–ü–æ–∂–∞—Ä–Ω–∞—è</button>
    <button id="btnAmbulance" onclick="emergencyCall(currentCountry,'—Å–∫–æ—Ä–∞—è')" data-i18n="ambulance">–°–∫–æ—Ä–∞—è</button>
  </div>

  <div class="panel" id="voicePanel">
    <strong data-i18n="voice_control">–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</strong>
    <span id="micState" class="badge off">–º–∏–∫—Ä–æ—Ñ–æ–Ω: –≤—ã–∫–ª</span>
    <div class="status" id="voiceHints" data-i18n="voice_examples">–ö–æ–º–∞–Ω–¥–∞: "–Ω–∞—á–∞—Ç—å", "—è–∑—ã–∫ ru", "–ø–æ–≥–æ–¥–∞", "–ø–æ–ª–∏—Ü–∏—è", "–Ω–∞–ø–æ–º–Ω–∏ –≤ 15:30 –ø–æ–∑–≤–æ–Ω–∏—Ç—å –º–∞–º–µ"</div>
    <button id="micToggle">–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
    <span id="recognized">---</span>
  </div>

  <!-- advice popup -->
  <div id="adviceAnimation" role="status" aria-live="polite">
    <div class="icon" id="adviceIcon">üß•</div>
    <div class="content">
      <div class="title" id="adviceTitle">–°–æ–≤–µ—Ç –ø–æ –æ–¥–µ–∂–¥–µ</div>
      <div class="desc" id="adviceDesc">–ï—Å–ª–∏ –Ω–µ –ø–æ—Å–ª—É—à–∞—Ç—å —Å–æ–≤–µ—Ç, –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è...</div>
    </div>
  </div>

  <!-- cartoon popup -->
  <div id="cartoonPopup" role="status" aria-live="polite">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:10px;align-items:center">
        <svg class="cartoon-svg" viewBox="0 0 120 120" aria-hidden="true">
          <defs><linearGradient id="gSkin" x1="0" x2="1"><stop offset="0" stop-color="#ffd9b3"/><stop offset="1" stop-color="#ffc899"/></linearGradient></defs>
          <g id="scene">
            <g id="bodyGroup" transform="translate(60,70)"><rect x="-22" y="-6" rx="8" ry="8" width="44" height="46" fill="#7aa2ff"/></g>
            <g id="headGroup" transform="translate(60,40)"><circle cx="0" cy="0" r="18" fill="url(#gSkin)"/><circle cx="-6" cy="-2" r="2" fill="#1f2937"/><circle cx="6" cy="-2" r="2" fill="#1f2937"/><path d="M -6 6 q 6 6 12 0" stroke="#111827" stroke-width="1.6" fill="none" stroke-linecap="round"/></g>
            <g id="accessory" transform="translate(60,58)"></g>
            <g id="sunGroup" transform="translate(98,18)" opacity="0"><circle cx="0" cy="0" r="10" fill="#FFD166"/><g stroke="#FFD166" stroke-width="2"><line x1="-16" y1="0" x2="-10" y2="0"/><line x1="16" y1="0" x2="10" y2="0"/><line x1="0" y1="-16" x2="0" y2="-10"/><line x1="0" y1="16" x2="0" y2="10"/></g></g>
            <g id="rainGroup" transform="translate(60,8)" opacity="0"><path class="rainDrop" d="M-18,0 q2,8 5,0" fill="#60a5fa" opacity="0.95"/><path class="rainDrop" d="M0,0 q2,8 5,0" fill="#60a5fa" opacity="0.95" style="animation-delay:120ms"/><path class="rainDrop" d="M18,0 q2,8 5,0" fill="#60a5fa" opacity="0.95" style="animation-delay:240ms"/></g>
            <g id="sneezeGroup" transform="translate(86,48)" opacity="0"><g class="sneeze"><ellipse cx="0" cy="0" rx="18" ry="10" fill="#e6eefb"/><circle cx="12" cy="-2" r="4" fill="#e6eefb"/></g></g>
          </g>
        </svg>
        <div style="flex:1">
          <div style="font-weight:700" id="cartoonTitle">–°–æ–≤–µ—Ç –ø–æ –æ–¥–µ–∂–¥–µ</div>
          <div id="cartoonDesc">–ï—Å–ª–∏ –Ω–µ –ø–æ—Å–ª—É—à–∞—Ç—å —Å–æ–≤–µ—Ç, –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è...</div>
          <span class="consequence-badge" id="consequenceBadge" style="display:none"></span>
        </div>
      </div>
      <div><button class="closeBtn" onclick="hideCartoon()" id="cartoonClose" aria-label="close">‚úï</button></div>
    </div>
  </div>

<script>
/* –ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª:
   - i18n –¥–ª—è ru,en,uk,hu,fr
   - –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è -> Nominatim -> –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω—ã
   - –ø–æ–≥–æ–¥–∞ (wttr.in)
   - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (localStorage), –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ
   - TTS (speakWithCallback) –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –º–∏–Ω–∏-–º—É–ª—å—Ç–∏–∫–∞ –ø–æ—Å–ª–µ —Ä–µ—á–∏
   - –≤—Å–ø–ª—ã–≤–∞—é—â–∏–π —Å–æ–≤–µ—Ç –ø–æ –æ–¥–µ–∂–¥–µ
   - –º–∏–Ω–∏-–º—É–ª—å—Ç (SVG) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π
   - STT (SpeechRecognition) –≥–æ–ª–æ—Å–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
   - —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –∏ –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –∑–≤–æ–Ω–∫–∞
*/

/* ---------------- i18n ---------------- */
let langCode = 'ru';
const i18n = {
  ru: {
    title:"–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è", choose_language:"–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ (ru, en, uk, hu, fr):",
    start:"–ù–∞—á–∞—Ç—å", status_label:"–°—Ç–∞—Ç—É—Å:", status_not_started:"–ù–µ –Ω–∞—á–∞—Ç–æ", locating:"–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...", location_failed:"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.",
    your_country:(c)=>`–í–∞—à–∞ —Å—Ç—Ä–∞–Ω–∞: ${c}`, weather_label:"–ü–æ–≥–æ–¥–∞:", reminders_label:"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:", emergency_actions:"–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:",
    check_sound:"–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–≤—É–∫", police:"–ü–æ–ª–∏—Ü–∏—è", fire:"–ü–æ–∂–∞—Ä–Ω–∞—è", ambulance:"–°–∫–æ—Ä–∞—è", voice_control:"–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
    voice_examples:'–ö–æ–º–∞–Ω–¥–∞: "–Ω–∞—á–∞—Ç—å", "—è–∑—ã–∫ ru", "–ø–æ–≥–æ–¥–∞", "–ø–æ–ª–∏—Ü–∏—è", "–Ω–∞–ø–æ–º–Ω–∏ –≤ 15:30 –ø–æ–∑–≤–æ–Ω–∏—Ç—å –º–∞–º–µ"', mic_on:"–º–∏–∫—Ä–æ—Ñ–æ–Ω: –≤–∫–ª", mic_off:"–º–∏–∫—Ä–æ—Ñ–æ–Ω: –≤—ã–∫–ª",
    mic_btn_on:"–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω", mic_btn_off:"–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω", browser_no_stt:"–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏.",
    say_start_first:"–°–Ω–∞—á–∞–ª–∞ —Å–∫–∞–∂–∏—Ç–µ '–Ω–∞—á–∞—Ç—å' –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è.", now_weather_tts:(t,d)=>`–°–µ–π—á–∞—Å ${t} –≥—Ä–∞–¥—É—Å–æ–≤, ${d}`,
    temp_weather_tts:(t,d)=>`–°–µ–π—á–∞—Å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ${t} –≥—Ä–∞–¥—É—Å–æ–≤, ${d}`, reminder_set:(time,task)=>`–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ ${time}: ${task}`,
    reminder_fire:(task,t,d)=>`–ù–∞–ø–æ–º–∏–Ω–∞—é: ${task}. –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ${t}¬∞C, –ø–æ–≥–æ–¥–∞: ${d}.`, clothing_advice_label:"–°–æ–≤–µ—Ç –ø–æ –æ–¥–µ–∂–¥–µ:",
    recognized_prefix:"–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:", country_set:(c)=>`–°—Ç—Ä–∞–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${c}`, add_reminder:"–î–æ–±–∞–≤–∏—Ç—å",
    prompt_sound:"–ö–∞–∫–æ–π –∑–≤—É–∫ –≤—ã —É—Å–ª—ã—à–∞–ª–∏? (–∫—Ä–∏–∫, —Å—Ç–æ–Ω, –ø–ª–∞—á, –≤–æ—Ä, –ø–æ–∂–∞—Ä –∏–ª–∏ '–Ω–µ—Ç')", prompt_help:"–í—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –±–æ–ª—å –∏–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å? (–¥–∞/–Ω–µ—Ç)",
    advise_doctor:"–†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É.", be_careful:"–ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã.",
    sound_not_recognized:"–ó–≤—É–∫ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∏–ª–∏ –Ω–µ—Ç –æ–ø–∞—Å–Ω–æ—Å—Ç–∏.",
    call_service_unavailable:(s)=>`–°–ª—É–∂–±–∞ ${s} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω–µ`,
    consequence_very_cold:"–ï—Å–ª–∏ –≤—ã –Ω–µ —Ç—ë–ø–ª–æ –æ–¥–µ–Ω–µ—Ç–µ—Å—å, –µ—Å—Ç—å —Ä–∏—Å–∫ –ø—Ä–æ—Å—Ç—É–¥—ã –∏–ª–∏ –ø–µ—Ä–µ–æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è.",
    consequence_cold:"–ï—Å–ª–∏ –Ω–µ –Ω–∞–¥–µ—Ç—å —Å–≤–∏—Ç–µ—Ä, –º–æ–∂–Ω–æ –∑—è–±–Ω—É—Ç—å –∏ –ø—Ä–æ—Å—Ç—É–¥–∏—Ç—å—Å—è.",
    consequence_cool:"–ï—Å–ª–∏ –Ω–µ –≤–∑—è—Ç—å –ª—ë–≥–∫—É—é –∫—É—Ä—Ç–∫—É, –±—É–¥–µ—Ç –Ω–µ–∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –Ω–∞ –≤–µ—Ç—Ä—É.",
    consequence_warm:"–ï—Å–ª–∏ –Ω–µ –Ω–∞–¥–µ—Ç—å –∫–µ–ø–∫—É, –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–µ–≥—Ä–µ–≤ –Ω–∞ —Å–æ–ª–Ω—Ü–µ.",
    consequence_hot:"–ï—Å–ª–∏ –Ω–µ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –æ—Ç —Å–æ–ª–Ω—Ü–∞, –µ—Å—Ç—å —Ä–∏—Å–∫ —Å–æ–ª–Ω–µ—á–Ω–æ–≥–æ —É–¥–∞—Ä–∞."
  },
  en: {
    title:"Emergency services and reminders", choose_language:"Choose language (ru, en, uk, hu, fr):",
    start:"Start", status_label:"Status:", status_not_started:"Not started", locating:"Detecting location...", location_failed:"Failed to determine location.",
    your_country:(c)=>`Your country: ${c}`, weather_label:"Weather:", reminders_label:"Reminders:", emergency_actions:"Emergency actions:",
    check_sound:"Check sound", police:"Police", fire:"Fire", ambulance:"Ambulance", voice_control:"Voice control",
    voice_examples:'Example: "start", "language en", "weather", "police", "remind at 15:30 call mom"', mic_on:"microphone: on", mic_off:"microphone: off",
    mic_btn_on:"Turn off mic", mic_btn_off:"Turn on mic", browser_no_stt:"Your browser does not support speech recognition.",
    say_start_first:"Say 'start' first to determine location.", now_weather_tts:(t,d)=>`It is now ${t} degrees, ${d}`,
    temp_weather_tts:(t,d)=>`Current temperature ${t} degrees, ${d}`, reminder_set:(time,task)=>`Reminder set at ${time}: ${task}`,
    reminder_fire:(task,t,d)=>`Reminder: ${task}. Temperature ${t}¬∞C, weather: ${d}.`, clothing_advice_label:"Clothing advice:",
    recognized_prefix:"Recognized:", country_set:(c)=>`Country set: ${c}`, add_reminder:"Add",
    prompt_sound:"What sound did you hear? (scream, groan, cry, thief, fire or 'no')", prompt_help:"Are you in pain or need help? (yes/no)",
    advise_doctor:"I recommend seeing a doctor.", be_careful:"Be careful.",
    sound_not_recognized:"Sound not recognized or no danger.",
    call_service_unavailable:(s)=>`Service ${s} is unavailable in your country`,
    consequence_very_cold:"If you don't dress warmly you may risk hypothermia or severe cold.",
    consequence_cold:"If you skip a sweater, you might get chilled and catch a cold.",
    consequence_cool:"Without a light jacket you'll feel uncomfortable in the wind.",
    consequence_warm:"Without a cap you might get overheated under the sun.",
    consequence_hot:"Without sun protection you risk sunstroke or severe dehydration."
  },
  uk: {
    title:"–ï–∫—Å—Ç—Ä–µ–Ω—ñ —Å–ª—É–∂–±–∏ —Ç–∞ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è", choose_language:"–û–±–µ—Ä—ñ—Ç—å –º–æ–≤—É (ru, en, uk, hu, fr):",
    start:"–ü–æ—á–∞—Ç–∏", status_label:"–°—Ç–∞—Ç—É—Å:", status_not_started:"–ù–µ —Ä–æ–∑–ø–æ—á–∞—Ç–æ", locating:"–í–∏–∑–Ω–∞—á–∞—î–º–æ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è...", location_failed:"–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è.",
    your_country:(c)=>`–í–∞—à–∞ –∫—Ä–∞—ó–Ω–∞: ${c}`, weather_label:"–ü–æ–≥–æ–¥–∞:", reminders_label:"–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è:", emergency_actions:"–ï–∫—Å—Ç—Ä–µ–Ω—ñ –¥—ñ—ó:",
    check_sound:"–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–≤—É–∫", police:"–ü–æ–ª—ñ—Ü—ñ—è", fire:"–ü–æ–∂–µ–∂–Ω–∞", ambulance:"–®–≤–∏–¥–∫–∞", voice_control:"–ì–æ–ª–æ—Å–æ–≤–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è",
    voice_examples:'–ü—Ä–∏–∫–ª–∞–¥–∏: "–ø–æ—á–∞—Ç–∏", "–º–æ–≤–∞ uk", "–ø–æ–≥–æ–¥–∞", "–ø–æ–ª—ñ—Ü—ñ—è", "–Ω–∞–≥–∞–¥–∞–π –æ 15:30 –∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–≤–∞—Ç–∏ –º–∞–º—ñ"', mic_on:"–º—ñ–∫—Ä–æ—Ñ–æ–Ω: —É–≤—ñ–º–∫", mic_off:"–º—ñ–∫—Ä–æ—Ñ–æ–Ω: –≤–∏–º–∫",
    mic_btn_on:"–í–∏–º–∫–Ω—É—Ç–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω", mic_btn_off:"–£–≤—ñ–º–∫–Ω—É—Ç–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω", browser_no_stt:"–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–æ–≤–ª–µ–Ω–Ω—è.",
    say_start_first:"–°–ø–æ—á–∞—Ç–∫—É —Å–∫–∞–∂—ñ—Ç—å '–ø–æ—á–∞—Ç–∏' –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è.", now_weather_tts:(t,d)=>`–ó–∞—Ä–∞–∑ ${t} –≥—Ä–∞–¥—É—Å—ñ–≤, ${d}`,
    temp_weather_tts:(t,d)=>`–ó–∞—Ä–∞–∑ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ${t} –≥—Ä–∞–¥—É—Å—ñ–≤, ${d}`, reminder_set:(time,task)=>`–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ ${time}: ${task}`,
    reminder_fire:(task,t,d)=>`–ù–∞–≥–∞–¥—É—é: ${task}. –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ${t}¬∞C, –ø–æ–≥–æ–¥–∞: ${d}.`, clothing_advice_label:"–ü–æ—Ä–∞–¥–∞ —â–æ–¥–æ –æ–¥—è–≥—É:",
    recognized_prefix:"–†–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ:", country_set:(c)=>`–ö—Ä–∞—ó–Ω—É –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${c}`, add_reminder:"–î–æ–¥–∞—Ç–∏",
    prompt_sound:"–Ø–∫–∏–π –∑–≤—É–∫ –≤–∏ –ø–æ—á—É–ª–∏? (–∫—Ä–∏–∫, —Å—Ç–æ–≥—ñ–Ω, –ø–ª–∞—á, –∑–ª–æ–¥—ñ–π, –ø–æ–∂–µ–∂–∞ –∞–±–æ '–Ω—ñ')", prompt_help:"–í–∞–º –±–æ–ª—è—á–µ –∞–±–æ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞? (—Ç–∞–∫/–Ω—ñ)",
    advise_doctor:"–†–µ–∫–æ–º–µ–Ω–¥—É—é –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –ª—ñ–∫–∞—Ä—è.", be_careful:"–ë—É–¥—å—Ç–µ –æ–±–µ—Ä–µ–∂–Ω—ñ.",
    sound_not_recognized:"–ó–≤—É–∫ –Ω–µ —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ –∞–±–æ –Ω–µ–±–µ–∑–ø–µ–∫–∏ –Ω–µ–º–∞—î.",
    call_service_unavailable:(s)=>`–°–ª—É–∂–±–∞ ${s} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ —É –≤–∞—à—ñ–π –∫—Ä–∞—ó–Ω—ñ`,
    consequence_very_cold:"–Ø–∫—â–æ –≤–∏ –Ω–µ –æ–¥—è–≥–Ω–µ—Ç–µ—Å—è —Ç–µ–ø–ª—ñ—à–µ, —ñ—Å–Ω—É—î —Ä–∏–∑–∏–∫ –ø–µ—Ä–µ–æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –∞–±–æ —Å–∏–ª—å–Ω–æ–≥–æ –∑–∞—Ö–≤–æ—Ä—é–≤–∞–Ω–Ω—è.",
    consequence_cold:"–Ø–∫—â–æ –Ω–µ –Ω–∞–¥—è–≥–Ω—É—Ç–∏ —Å–≤–µ—Ç—Ä, –º–æ–∂–Ω–∞ –∑–º–µ—Ä–∑–Ω—É—Ç–∏ —ñ –∑–∞—Ö–≤–æ—Ä—ñ—Ç–∏.",
    consequence_cool:"–Ø–∫—â–æ –Ω–µ –≤–∑—è—Ç–∏ –ª–µ–≥–∫—É –∫—É—Ä—Ç–∫—É ‚Äî –±—É–¥–µ –Ω–µ–∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –Ω–∞ –≤—ñ—Ç—Ä—ñ.",
    consequence_warm:"–Ø–∫—â–æ –Ω–µ –Ω–∞–¥—è–≥–Ω—É—Ç–∏ –∫–µ–ø–∫—É, –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–≥—Ä—ñ—Ç–∏—Å—è –Ω–∞ —Å–æ–Ω—Ü—ñ.",
    consequence_hot:"–Ø–∫—â–æ –Ω–µ –∑–∞—Ö–∏—Å—Ç–∏—Ç–∏—Å—è –≤—ñ–¥ —Å–æ–Ω—Ü—è ‚Äî —î —Ä–∏–∑–∏–∫ —Å–æ–Ω—è—á–Ω–æ–≥–æ —É–¥–∞—Ä—É."
  },
  hu: {
    title:"Seg√©lyh√≠v√°s √©s eml√©keztet≈ëk", choose_language:"V√°lassz nyelvet (ru, en, uk, hu, fr):",
    start:"Ind√≠t√°s", status_label:"√Ållapot:", status_not_started:"Nincs elind√≠tva", locating:"Helyzet meghat√°roz√°sa...", location_failed:"Nem siker√ºlt meghat√°rozni a helyzetet.",
    your_country:(c)=>`Orsz√°god: ${c}`, weather_label:"Id≈ëj√°r√°s:", reminders_label:"Eml√©keztet≈ëk:", emergency_actions:"V√©szhelyzeti m≈±veletek:",
    check_sound:"Hang ellen≈ërz√©se", police:"Rend≈ërs√©g", fire:"T≈±zolt√≥s√°g", ambulance:"Ment≈ë", voice_control:"Hangvez√©rl√©s",
    voice_examples:'P√©lda: "ind√≠t√°s", "nyelv hu", "id≈ëj√°r√°s", "rend≈ërs√©g", "eml√©keztess 15:30-kor, hogy felh√≠vjam anyut"', mic_on:"mikrofon: be", mic_off:"mikrofon: ki",
    mic_btn_on:"Mikrofon kikapcsol√°sa", mic_btn_off:"Mikrofon bekapcsol√°sa", browser_no_stt:"A b√∂ng√©sz≈ëd nem t√°mogatja a besz√©dfelismer√©st.",
    say_start_first:"Mondd el≈ësz√∂r, hogy 'ind√≠t√°s' a helyzet meghat√°roz√°s√°hoz.", now_weather_tts:(t,d)=>`Most ${t} fok van, ${d}`,
    temp_weather_tts:(t,d)=>`Jelenlegi h≈ëm√©rs√©klet ${t} fok, ${d}`, reminder_set:(time,task)=>`Eml√©keztet≈ë be√°ll√≠tva ${time}-ra: ${task}`,
    reminder_fire:(task,t,d)=>`Eml√©keztet≈ë: ${task}. H≈ëm√©rs√©klet ${t}¬∞C, id≈ëj√°r√°s: ${d}.`, clothing_advice_label:"√ñlt√∂zk√∂d√©si tan√°cs:",
    recognized_prefix:"Felismerve:", country_set:(c)=>`Orsz√°g be√°ll√≠tva: ${c}`, add_reminder:"Hozz√°ad",
    prompt_sound:"Milyen hangot hallott√°l? (sikoly, ny√∂g√©s, s√≠r√°s, tolvaj, t≈±z vagy 'nem')", prompt_help:"F√°jdalmat √©rzel vagy seg√≠ts√©gre van sz√ºks√©ged? (igen/nem)",
    advise_doctor:"Javaslom, fordulj orvoshoz.", be_careful:"L√©gy √≥vatos.",
    sound_not_recognized:"A hang nem felismerhet≈ë vagy nincs vesz√©ly.",
    call_service_unavailable:(s)=>`A(z) ${s} szolg√°ltat√°s nem √©rhet≈ë el az orsz√°godban`,
    consequence_very_cold:"Ha nem √∂lt√∂z√∂l fel melegen, megf√°z√°s vagy kih≈±l√©s vesz√©lye √°ll fenn.",
    consequence_cold:"Ha nem veszel pul√≥vert, megf√°zhatsz.",
    consequence_cool:"Ha nem viszel k√∂nny≈± dzsekit, k√©nyelmetlen lesz a sz√©l.",
    consequence_warm:"Ha nem veszel sapk√°t, t√∫lhev√ºlhetsz a napon.",
    consequence_hot:"Ha nem v√©dekezel a napon, napsz√∫r√°st kaphatsz."
  },
  fr: {
    title:"Services d'urgence et rappels", choose_language:"Choisissez la langue (ru, en, uk, hu, fr):",
    start:"D√©marrer", status_label:"Statut:", status_not_started:"Non d√©marr√©", locating:"D√©tection de la position...", location_failed:"Impossible de d√©terminer la position.",
    your_country:(c)=>`Votre pays: ${c}`, weather_label:"M√©t√©o:", reminders_label:"Rappels:", emergency_actions:"Actions d'urgence:",
    check_sound:"V√©rifier le son", police:"Police", fire:"Pompiers", ambulance:"Ambulance", voice_control:"Commande vocale",
    voice_examples:'Exemple: "d√©marrer", "langue fr", "m√©t√©o", "police", "rappelle √† 15:30 d\'appeler maman"', mic_on:"micro: activ√©", mic_off:"micro: d√©sactiv√©",
    mic_btn_on:"D√©sactiver le micro", mic_btn_off:"Activer le micro", browser_no_stt:"Votre navigateur ne prend pas en charge la reconnaissance vocale.",
    say_start_first:"Dites d'abord 'd√©marrer' pour d√©terminer la position.", now_weather_tts:(t,d)=>`Il fait ${t} degr√©s, ${d}`,
    temp_weather_tts:(t,d)=>`Temp√©rature actuelle ${t} degr√©s, ${d}`, reminder_set:(time,task)=>`Rappel r√©gl√© √† ${time} : ${task}`,
    reminder_fire:(task,t,d)=>`Rappel: ${task}. Temp√©rature ${t}¬∞C, m√©t√©o: ${d}.`, clothing_advice_label:"Conseil vestimentaire:",
    recognized_prefix:"Reconnu :", country_set:(c)=>`Pays d√©fini : ${c}`, add_reminder:"Ajouter",
    prompt_sound:"Quel son avez-vous entendu ? (cri, g√©missement, pleur, voleur, feu ou 'non')", prompt_help:"Avez-vous mal ou besoin d'aide ? (oui/non)",
    advise_doctor:"Je recommande de consulter un m√©decin.", be_careful:"Soyez prudent.",
    sound_not_recognized:"Son non reconnu ou aucun danger.",
    call_service_unavailable:(s)=>`Le service ${s} n'est pas disponible dans votre pays`,
    consequence_very_cold:"Si vous ne vous couvrez pas, risque d'hypothermie ou de grave rhume.",
    consequence_cold:"Sans pull, vous risquez d'avoir froid et de tomber malade.",
    consequence_cool:"Sans veste l√©g√®re, le vent sera inconfortable.",
    consequence_warm:"Sans casquette, vous pouvez surchauffer au soleil.",
    consequence_hot:"Sans protection solaire, risque de coup de chaleur."
  }
};
function tt(key, ...args){ const bucket = i18n[langCode] || i18n.ru; const v = bucket[key]; return typeof v === 'function' ? v(...args) : (v ?? (typeof i18n.ru[key]==='function' ? i18n.ru[key](...args) : i18n.ru[key])); }

/* ---------------- Utils ---------------- */
function mapLangToBCP47(l){ switch((l||'ru').toLowerCase()){case 'ru':return 'ru-RU';case 'en':return 'en-US';case 'uk':return 'uk-UA';case 'hu':return 'hu-HU';case 'fr':return 'fr-FR';default:return 'ru-RU'} }
function normalizeString(s){ if(!s) return ''; try{return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim()}catch(e){return String(s).toLowerCase().trim()} }

/* ---------------- Country translations & normalization ---------------- */
const COUNTRY_TRANSLATIONS = {
  "–†–æ—Å—Å–∏—è":{ru:"–†–æ—Å—Å–∏—è",en:"Russia",uk:"–†–æ—Å—ñ—è",hu:"Oroszorsz√°g",fr:"Russie"},
  "–°–®–ê":{ru:"–°–®–ê",en:"USA",uk:"–°–®–ê",hu:"USA",fr:"√âtats-Unis"},
  "–£–∫—Ä–∞–∏–Ω–∞":{ru:"–£–∫—Ä–∞–∏–Ω–∞",en:"Ukraine",uk:"–£–∫—Ä–∞—ó–Ω–∞",hu:"Ukrajna",fr:"Ukraine"},
  "–í–µ–Ω–≥—Ä–∏—è":{ru:"–í–µ–Ω–≥—Ä–∏—è",en:"Hungary",uk:"–£–≥–æ—Ä—â–∏–Ω–∞",hu:"Magyarorsz√°g",fr:"Hongrie"},
  "–§—Ä–∞–Ω—Ü–∏—è":{ru:"–§—Ä–∞–Ω—Ü–∏—è",en:"France",uk:"–§—Ä–∞–Ω—Ü—ñ—è",hu:"Franciaorsz√°g",fr:"France"},
  "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ":{ru:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",en:"Unknown",uk:"–ù–µ–≤—ñ–¥–æ–º–æ",hu:"Ismeretlen",fr:"Inconnu"}
};
const countryAliases = {
  "—Ä–æ—Å—Å–∏—è":"–†–æ—Å—Å–∏—è","—Ä—Ñ":"–†–æ—Å—Å–∏—è","russia":"–†–æ—Å—Å–∏—è","usa":"–°–®–ê","—Å—à–∞":"–°–®–ê","united states":"–°–®–ê","—É–∫–∞–Ω–∏—è":"–£–∫—Ä–∞–∏–Ω–∞","—É–∫—Ä–∞–∏–Ω–∞":"–£–∫—Ä–∞–∏–Ω–∞","hungary":"–í–µ–Ω–≥—Ä–∏—è","–≤–µ–Ω–≥—Ä–∏—è":"–í–µ–Ω–≥—Ä–∏—è","france":"–§—Ä–∞–Ω—Ü–∏—è","—Ñ—Ä–∞–Ω—Ü–∏—è":"–§—Ä–∞–Ω—Ü–∏—è"
};
function normalizeCountryName(raw){
  if(!raw) return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
  const s = normalizeString(raw);
  if(s.length===2){
    const map = {ru:"–†–æ—Å—Å–∏—è",us:"–°–®–ê",ua:"–£–∫—Ä–∞–∏–Ω–∞",hu:"–í–µ–Ω–≥—Ä–∏—è",fr:"–§—Ä–∞–Ω—Ü–∏—è"};
    if(map[s]) return map[s];
  }
  if(countryAliases[s]) return countryAliases[s];
  for(const canon of Object.keys(COUNTRY_TRANSLATIONS)){
    for(const t of Object.values(COUNTRY_TRANSLATIONS[canon])){
      if(normalizeString(t)===s) return canon;
    }
  }
  const found = Object.keys(countryAliases).find(a => s.includes(a));
  if(found) return countryAliases[found];
  return raw;
}
function translateCountryName(canon, targetLang){
  if(!canon) canon="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
  const t = COUNTRY_TRANSLATIONS[canon];
  if(!t) return canon;
  return t[targetLang] || t.en || canon;
}

/* ---------------- Weather (wttr.in) ---------------- */
async function getWeather(lat, lon){
  try{
    const url = `https://wttr.in/${lat},${lon}?format=j1`;
    const res = await fetch(url);
    const data = await res.json();
    const cur = data.current_condition && data.current_condition[0];
    if(!cur) return null;
    const raw = cur.weatherDesc?.[0]?.value || '';
    return { temp: Number(cur.temp_C), desc: raw, rawDesc: raw };
  }catch(e){ console.warn('getWeather',e); return null; }
}

/* ---------------- Reverse geocode (Nominatim) ---------------- */
async function getCountry(lat, lon){
  try{
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
    const data = await res.json();
    const rawCountry = data?.address?.country || data?.address?.country_code || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
    return normalizeCountryName(rawCountry);
  }catch(e){ console.warn('getCountry',e); return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"; }
}

/* ---------------- Geolocation ---------------- */
async function getLocation(){
  return new Promise(resolve=>{
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>resolve({lat:pos.coords.latitude,lon:pos.coords.longitude}),
        err=>{console.warn('geo err',err); resolve(null)}, {timeout:10000});
    } else resolve(null);
  });
}

/* ---------------- TTS with callback ---------------- */
function speakWithCallback(text, lang, onEnd){
  try{
    if(!('speechSynthesis' in window)){ if(typeof onEnd==='function') setTimeout(onEnd,800); return; }
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = mapLangToBCP47(lang);
    u.onend = ()=>{ if(typeof onEnd==='function') onEnd(); };
    u.onerror = ()=>{ if(typeof onEnd==='function') onEnd(); };
    speechSynthesis.speak(u);
  }catch(e){ console.warn('TTS',e); if(typeof onEnd==='function') setTimeout(onEnd,800); }
}

/* ---------------- Clothing advice ---------------- */
const CLOTHING_ADVICE = {
  ru:{very_cold:"–û—á–µ–Ω—å —Ö–æ–ª–æ–¥–Ω–æ ‚Äî –Ω–∞–¥–µ–Ω—å—Ç–µ —Ç—ë–ø–ª—É—é –∫—É—Ä—Ç–∫—É, —à–∞—Ä—Ñ –∏ –ø–µ—Ä—á–∞—Ç–∫–∏.", cold:"–•–æ–ª–æ–¥–Ω–æ ‚Äî –º–æ–∂–Ω–æ –Ω–∞–¥–µ—Ç—å —Å–≤–∏—Ç–µ—Ä –∏–ª–∏ –ª—ë–≥–∫—É—é –∫—É—Ä—Ç–∫—É.", cool:"–ü—Ä–æ—Ö–ª–∞–¥–Ω–æ ‚Äî –≤–æ–∑—å–º–∏—Ç–µ –≤–µ—Ç—Ä–æ–≤–∫—É –∏–ª–∏ –ª—ë–≥–∫—É—é –∫—É—Ä—Ç–∫—É.", warm:"–¢—ë–ø–ª–æ ‚Äî –º–æ–∂–Ω–æ –Ω–∞–¥–µ—Ç—å —Ñ—É—Ç–±–æ–ª–∫—É, –≤–æ–∑–º–æ–∂–Ω–æ –∫–µ–ø–∫—É.", hot:"–ñ–∞—Ä–∫–æ ‚Äî –Ω–∞–¥–µ–Ω—å—Ç–µ –ª—ë–≥–∫—É—é –æ–¥–µ–∂–¥—É –∏ –∫–µ–ø–∫—É, –ø–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã."},
  en:{very_cold:"Very cold ‚Äî wear a warm coat, scarf and gloves.", cold:"Cold ‚Äî you can wear a sweater or light jacket.", cool:"Cool ‚Äî take a light jacket or windbreaker.", warm:"Warm ‚Äî a t-shirt is fine, consider wearing a cap.", hot:"Hot ‚Äî wear light clothing and a cap, stay hydrated."},
  uk:{very_cold:"–î—É–∂–µ —Ö–æ–ª–æ–¥–Ω–æ ‚Äî –Ω–∞–¥—è–≥–Ω—ñ—Ç—å —Ç–µ–ø–ª—É –∫—É—Ä—Ç–∫—É, —à–∞—Ä—Ñ —ñ —Ä—É–∫–∞–≤–∏—á–∫–∏.", cold:"–•–æ–ª–æ–¥–Ω–æ ‚Äî –º–æ–∂–Ω–∞ –Ω–∞–¥—ñ—Ç–∏ —Å–≤–µ—Ç—Ä –∞–±–æ –ª–µ–≥–∫—É –∫—É—Ä—Ç–∫—É.", cool:"–ü—Ä–æ—Ö–æ–ª–æ–¥–Ω–æ ‚Äî –≤—ñ–∑—å–º—ñ—Ç—å –≤—ñ—Ç—Ä–æ–≤–∫—É –∞–±–æ –ª–µ–≥–∫—É –∫—É—Ä—Ç–∫—É.", warm:"–¢–µ–ø–ª–æ ‚Äî –º–æ–∂–Ω–∞ –Ω–∞–¥—ñ—Ç–∏ —Ñ—É—Ç–±–æ–ª–∫—É, –º–æ–∂–ª–∏–≤–æ –∫–µ–ø–∫—É.", hot:"–°–ø–µ–∫–æ—Ç–Ω–æ ‚Äî –Ω–æ—Å—ñ—Ç—å –ª–µ–≥–∫–∏–π –æ–¥—è–≥ —ñ –∫–µ–ø–∫—É, –ø–∏–π—Ç–µ –±—ñ–ª—å—à–µ –≤–æ–¥–∏."},
  hu:{very_cold:"Nagyon hideg ‚Äî viselj meleg kab√°tot, s√°lat √©s keszty≈±t.", cold:"Hideg ‚Äî viselj pul√≥vert vagy k√∂nny≈± dzsekit.", cool:"H≈±v√∂s ‚Äî vigy√©l magaddal egy k√∂nny≈± dzsekit vagy sz√©lkab√°tot.", warm:"Meleg ‚Äî p√≥l√≥ el√©g, √©rdemes sapk√°t vinni.", hot:"Forr√≥ ‚Äî viselj k√∂nny≈± ruh√°t √©s sapk√°t, igy√°l sok vizet."},
  fr:{very_cold:"Tr√®s froid ‚Äî mettez un manteau chaud, une √©charpe et des gants.", cold:"Froid ‚Äî vous pouvez mettre un pull ou une veste l√©g√®re.", cool:"Frais ‚Äî prenez une veste l√©g√®re ou un coupe-vent.", warm:"Chaud ‚Äî un t-shirt suffit, pensez √† une casquette.", hot:"Tr√®s chaud ‚Äî portez des v√™tements l√©gers et une casquette, hydratez-vous."}
};
function getClothingAdvice(tempC){
  const t = Number(tempC);
  const dict = CLOTHING_ADVICE[langCode] || CLOTHING_ADVICE.ru;
  if(isNaN(t)) return '';
  if(t<=5) return dict.very_cold;
  if(t<=15) return dict.cold;
  if(t<=22) return dict.cool;
  if(t<=30) return dict.warm;
  return dict.hot;
}
function getTempCategory(tempC){
  const t = Number(tempC);
  if(isNaN(t)) return 'cool';
  if(t<=5) return 'very_cold';
  if(t<=15) return 'cold';
  if(t<=22) return 'cool';
  if(t<=30) return 'warm';
  return 'hot';
}

/* ---------------- Reminders (localStorage) ---------------- */
let reminders = []; // {id,time,task,lat,lon,spoken}
const STORAGE_KEY = 'es_reminders_v1';

function loadReminders(){
  try{ const raw = localStorage.getItem(STORAGE_KEY); reminders = raw ? JSON.parse(raw) : []; }catch(e){ reminders = []; }
  displayReminders();
  reminders.forEach(r=>{ if(!r.spoken) scheduleReminderCheck(r); });
}
function saveReminders(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(reminders)); }

function addReminder(){
  const time = document.getElementById('reminderTime').value;
  const task = document.getElementById('reminderText').value.trim();
  if(!time || !task) return alert({ru:'–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –∏ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è', en:'Enter time and reminder text'}[langCode] || 'Enter time and text');
  if(!lastLocation) return alert(tt('say_start_first'));
  const id = Date.now()+Math.random();
  const reminder = {id,time,task,lat:lastLocation.lat,lon:lastLocation.lon,spoken:false};
  reminders.push(reminder); saveReminders(); displayReminders(); scheduleReminderCheck(reminder);
  document.getElementById('reminderTime').value=''; document.getElementById('reminderText').value='';
  speakWithCallback(tt('reminder_set', time, task), langCode, null);
}

function displayReminders(){
  const container = document.getElementById('reminderList');
  if(!reminders.length){ container.innerHTML = '<span class="small">---</span>'; return; }
  container.innerHTML = '';
  reminders.forEach(r=>{
    const div = document.createElement('div'); div.className='reminder-item';
    const left = document.createElement('div'); left.innerHTML = `<strong>${r.time}</strong> <span class="reminder-text">${r.task}</span>`;
    const right = document.createElement('div');
    const del = document.createElement('button'); del.textContent='–£–¥–∞–ª–∏—Ç—å'; del.className='ghost'; del.onclick = ()=>{ reminders = reminders.filter(x=>x.id!==r.id); saveReminders(); displayReminders(); };
    right.appendChild(del); div.appendChild(left); div.appendChild(right); container.appendChild(div);
  });
}

/* schedule: check every 15s */
function scheduleReminderCheck(reminder){
  const timer = setInterval(async ()=>{
    const now = new Date(); const hh = String(now.getHours()).padStart(2,'0'); const mm = String(now.getMinutes()).padStart(2,'0');
    if(`${hh}:${mm}` === reminder.time && !reminder.spoken){
      clearInterval(timer);
      reminder.spoken = true; saveReminders();
      const weather = await getWeather(reminder.lat, reminder.lon);
      let spokenMsg = tt('reminder_set', reminder.time, reminder.task);
      if(weather){ spokenMsg = tt('reminder_fire', reminder.task, weather.temp, weather.desc); const advice = getClothingAdvice(weather.temp); if(advice) spokenMsg = `${spokenMsg} ${tt('clothing_advice_label')} ${advice}`; }
      // show short popup immediately
      showAdvicePopup(weather?.temp, getClothingAdvice(weather?.temp));
      // speak and after speech ends show cartoon automatically
      speakWithCallback(spokenMsg, langCode, ()=>{ try{ showCartoonAnimation(weather?.temp); }catch(e){console.warn(e);} });
      // remove from active reminders list (keeps in storage as spoken flag)
      reminders = reminders.filter(r=>r.id!==reminder.id); saveReminders(); displayReminders();
    }
  }, 15*1000);
}

/* ---------------- Advice popup & cartoon ---------------- */
let adviceHideTimer = null;
function showAdvicePopup(temp, adviceText){
  const pop = document.getElementById('adviceAnimation');
  const icon = document.getElementById('adviceIcon');
  const title = document.getElementById('adviceTitle');
  const desc = document.getElementById('adviceDesc');
  title.textContent = tt('clothing_advice_label');
  desc.textContent = adviceText || '';
  const icons = {very_cold:'ü•∂', cold:'üß•', cool:'üå¨Ô∏è', warm:'üß¢', hot:'‚òÄÔ∏è'};
  icon.textContent = icons[getTempCategory(temp)] || '‚ÑπÔ∏è';
  pop.classList.add('show');
  if(adviceHideTimer) clearTimeout(adviceHideTimer);
  adviceHideTimer = setTimeout(()=>pop.classList.remove('show'),6000);
}

let cartoonHideTimer = null;
function showCartoonAnimation(categoryOrTemp){
  let category = categoryOrTemp;
  if(typeof categoryOrTemp === 'number' || !isNaN(Number(categoryOrTemp))){
    const t = Number(categoryOrTemp);
    if(t<=5) category='very_cold'; else if(t<=15) category='cold'; else if(t<=22) category='cool'; else if(t<=30) category='warm'; else category='hot';
  }
  const popup = document.getElementById('cartoonPopup');
  const title = document.getElementById('cartoonTitle');
  const desc = document.getElementById('cartoonDesc');
  const badge = document.getElementById('consequenceBadge');
  const sun = document.getElementById('sunGroup');
  const rain = document.getElementById('rainGroup');
  const sneeze = document.getElementById('sneezeGroup');
  const head = document.getElementById('headGroup');
  const accessory = document.getElementById('accessory');

  const CONSEQUENCES = {
    very_cold: tt('consequence_very_cold'),
    cold: tt('consequence_cold'),
    cool: tt('consequence_cool'),
    warm: tt('consequence_warm'),
    hot: tt('consequence_hot')
  };
  const LABELS = { very_cold:{ru:'–û—á–µ–Ω—å —Ö–æ–ª–æ–¥–Ω–æ',en:'Very cold',uk:'–î—É–∂–µ —Ö–æ–ª–æ–¥–Ω–æ',hu:'Nagyon hideg',fr:'Tr√®s froid'}, cold:{ru:'–•–æ–ª–æ–¥–Ω–æ',en:'Cold',uk:'–•–æ–ª–æ–¥–Ω–æ',hu:'Hideg',fr:'Froid'}, cool:{ru:'–ü—Ä–æ—Ö–ª–∞–¥–Ω–æ',en:'Cool',uk:'–ü—Ä–æ—Ö–æ–ª–æ–¥–Ω–æ',hu:'H≈±v√∂s',fr:'Frais'}, warm:{ru:'–¢—ë–ø–ª–æ',en:'Warm',uk:'–¢–µ–ø–ª–æ',hu:'Meleg',fr:'Chaud'}, hot:{ru:'–ñ–∞—Ä–∫–æ',en:'Hot',uk:'–°–ø–µ–∫–æ—Ç–Ω–æ',hu:'Forr√≥',fr:'Tr√®s chaud'} };

  title.textContent = (LABELS[category] && LABELS[category][langCode]) || LABELS[category].ru || '–°–æ–≤–µ—Ç';
  desc.textContent = (CONSEQUENCES[category] || '').split('.')[0] + '.';
  badge.style.display='block'; badge.textContent = CONSEQUENCES[category] || '';

  // reset visuals
  sun.style.opacity=0; sun.classList.remove('sunPulse');
  rain.style.opacity=0; sneeze.style.opacity=0; head.classList.remove('shiver'); accessory.innerHTML='';

  if(category==='very_cold' || category==='cold'){
    head.classList.add('shiver');
    accessory.innerHTML = '<rect x="-26" y="-2" rx="4" ry="4" width="52" height="12" fill="#ff8b8b"></rect>';
  } else if(category==='cool'){
    head.classList.add('shiver');
    accessory.innerHTML = '<rect x="-20" y="-10" rx="6" ry="6" width="40" height="8" fill="#9ec5ff" transform="rotate(-8)"></rect>';
    if(Math.random()>0.45) rain.style.opacity=1;
  } else if(category==='warm' || category==='hot'){
    sun.style.opacity=1; sun.classList.add('sunPulse');
    accessory.innerHTML = '<circle cx="0" cy="-12" r="10" fill="#f7c948"></circle>';
  }
  if(category==='very_cold' && Math.random()>0.4){
    setTimeout(()=>{ sneeze.style.opacity=1; const el=sneeze.querySelector('.sneeze'); if(el){ el.classList.remove('sneeze'); void el.offsetWidth; el.classList.add('sneeze'); } },500);
  }
  popup.classList.add('show');
  if(cartoonHideTimer) clearTimeout(cartoonHideTimer);
  cartoonHideTimer = setTimeout(()=>hideCartoon(),7000);
}
function hideCartoon(){
  const popup=document.getElementById('cartoonPopup'); popup.classList.remove('show');
  const sun=document.getElementById('sunGroup'); sun.style.opacity=0; sun.classList.remove('sunPulse');
  const rain=document.getElementById('rainGroup'); rain.style.opacity=0;
  const head=document.getElementById('headGroup'); head.classList.remove('shiver');
  const sneeze=document.getElementById('sneezeGroup'); sneeze.style.opacity=0;
  document.getElementById('accessory').innerHTML='';
  document.getElementById('consequenceBadge').style.display='none';
  if(cartoonHideTimer){ clearTimeout(cartoonHideTimer); cartoonHideTimer=null; }
}

/* ---------------- Emergency numbers and logic ---------------- */
const emergencyNumbers = {
  "–†–æ—Å—Å–∏—è":{"–ø–æ–ª–∏—Ü–∏—è":"+78001005050","–ø–æ–∂–∞—Ä–Ω–∞—è":"+101","—Å–∫–æ—Ä–∞—è":"+103","—Å–ø–∞—Å–∞—Ç–µ–ª–∏":"+112"},
  "–°–®–ê":{"–ø–æ–ª–∏—Ü–∏—è":"+911","–ø–æ–∂–∞—Ä–Ω–∞—è":"+911","—Å–∫–æ—Ä–∞—è":"+911","—Å–ø–∞—Å–∞—Ç–µ–ª–∏":"+911"},
  "–£–∫—Ä–∞–∏–Ω–∞":{"–ø–æ–ª–∏—Ü–∏—è":"+102","–ø–æ–∂–∞—Ä–Ω–∞—è":"+101","—Å–∫–æ—Ä–∞—è":"+103","—Å–ø–∞—Å–∞—Ç–µ–ª–∏":"+112"},
  "–í–µ–Ω–≥—Ä–∏—è":{"–ø–æ–ª–∏—Ü–∏—è":"+112","–ø–æ–∂–∞—Ä–Ω–∞—è":"+105","—Å–∫–æ—Ä–∞—è":"+104","—Å–ø–∞—Å–∞—Ç–µ–ª–∏":"+112"},
  "–§—Ä–∞–Ω—Ü–∏—è":{"–ø–æ–ª–∏—Ü–∏—è":"+17","–ø–æ–∂–∞—Ä–Ω–∞—è":"+18","—Å–∫–æ—Ä–∞—è":"+15","—Å–ø–∞—Å–∞—Ç–µ–ª–∏":"+112"}
};
function emergencyCall(country, service){
  const canon = normalizeCountryName(country);
  if(emergencyNumbers[canon] && emergencyNumbers[canon][service]){
    const num = emergencyNumbers[canon][service];
    const ttsKey = service==='–ø–æ–ª–∏—Ü–∏—è' ? 'call_police_tts' : (service==='–ø–æ–∂–∞—Ä–Ω–∞—è' ? 'call_fire_tts' : 'call_ambulance_tts');
    // fallback to simple speaking
    const msg = { ru: `${service} ${num}`, en: `Calling ${service} ${num}` }[langCode] || `${service} ${num}`;
    speakWithCallback(msg, langCode, null);
  } else {
    const display = translateCountryName(canon, langCode);
    speakWithCallback(tt('call_service_unavailable', display), langCode, null);
  }
}
function emergencySoundDetection(country){
  const promptText = tt('prompt_sound');
  const dict = {
    ru:{harm:["–∫—Ä–∏–∫","—Å—Ç–æ–Ω","–ø–ª–∞—á"],thief:"–≤–æ—Ä",fire:"–ø–æ–∂–∞—Ä",yes:"–¥–∞",no:"–Ω–µ—Ç"},
    en:{harm:["scream","groan","cry"],thief:"thief",fire:"fire",yes:"yes",no:"no"},
    uk:{harm:["–∫—Ä–∏–∫","—Å—Ç–æ–≥—ñ–Ω","–ø–ª–∞—á"],thief:"–∑–ª–æ–¥—ñ–π",fire:"–ø–æ–∂–µ–∂–∞",yes:"—Ç–∞–∫",no:"–Ω—ñ"},
    hu:{harm:["sikoly","ny√∂g√©s","s√≠r√°s"],thief:"tolvaj",fire:"t≈±z",yes:"igen",no:"nem"},
    fr:{harm:["cri","g√©missement","pleur"],thief:"voleur",fire:"feu",yes:"oui",no:"non"}
  };
  const d = dict[langCode] || dict.ru;
  const sound = prompt(promptText);
  if(!sound){ speakWithCallback(tt('sound_not_recognized'), langCode); return; }
  const s = sound.toLowerCase().trim();
  if(d.harm.includes(s)){
    const help = prompt(tt('prompt_help'))?.toLowerCase();
    if(help === d.yes) speakWithCallback(tt('advise_doctor'), langCode); else speakWithCallback(tt('be_careful'), langCode);
  } else if(s === d.thief) emergencyCall(country,'–ø–æ–ª–∏—Ü–∏—è');
  else if(s === d.fire) emergencyCall(country,'–ø–æ–∂–∞—Ä–Ω–∞—è');
  else speakWithCallback(tt('sound_not_recognized'), langCode);
}

/* ---------------- Speech Recognition (STT) ---------------- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null; let isListening = false;
function ensureRecognition(){
  if(!SpeechRecognition) return null;
  if(recognition) return recognition;
  recognition = new SpeechRecognition();
  recognition.continuous = true; recognition.interimResults = false;
  recognition.lang = mapLangToBCP47(langCode);
  recognition.onresult = (ev)=>{
    const last = ev.results[ev.results.length-1];
    if(!last) return;
    const text = (last[0]?.transcript||'').trim();
    if(!text) return;
    document.getElementById('recognized').innerText = `${tt('recognized_prefix')} ${text}`;
    handleVoiceCommand(text.toLowerCase());
  };
  recognition.onstart = ()=>updateMicBadge(true);
  recognition.onend = ()=>updateMicBadge(false);
  recognition.onerror = ()=>updateMicBadge(false);
  return recognition;
}
function updateMicBadge(on){ isListening = !!on; const b = document.getElementById('micState'); const btn = document.getElementById('micToggle'); b.classList.remove('on','off'); b.classList.add(on ? 'on' : 'off'); b.textContent = on ? tt('mic_on') : tt('mic_off'); btn.textContent = on ? tt('mic_btn_on') : tt('mic_btn_off'); }
function startListening(){ const r = ensureRecognition(); if(!r){ document.getElementById('recognized').innerText = tt('browser_no_stt'); return; } try{ r.lang = mapLangToBCP47(langCode); r.start(); }catch(e){} }
function stopListening(){ if(!recognition) return; try{ recognition.stop(); }catch(e){} }
document.getElementById('micToggle').addEventListener('click', ()=>{ if(isListening) stopListening(); else startListening(); });

/* ---------------- Voice command handling ---------------- */
const commandPatterns = {
  ru:{ stopKeywords:["—Å—Ç–æ–ø","–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å","–≤—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω"], startKeywords:["–Ω–∞—á–∞—Ç—å","—Å—Ç–∞—Ä—Ç"], weatherKeywords:["–ø–æ–≥–æ–¥–∞"], langRegex:/\b—è–∑—ã–∫\s+(ru|en|uk|hu|fr)\b/, countryRegex:/\b—Å—Ç—Ä–∞–Ω–∞\s+([a-zA-Z\u0400-\u04FF\s\.-]+)/, reminderRegex:/\b–Ω–∞–ø–æ–º–Ω–∏\s+(?:–≤|–Ω–∞)\s+(\d{1,2}[:\.]\d{2})\s+(.+)/, services:[{keywords:["–ø–æ–ª–∏—Ü–∏"],service:"–ø–æ–ª–∏—Ü–∏—è"},{keywords:["–ø–æ–∂–∞—Ä–Ω"],service:"–ø–æ–∂–∞—Ä–Ω–∞—è"},{keywords:["—Å–∫–æ—Ä–∞"],service:"—Å–∫–æ—Ä–∞—è"}] },
  en:{ stopKeywords:["stop","turn off mic"], startKeywords:["start","begin"], weatherKeywords:["weather"], langRegex:/\blanguage\s+(ru|en|uk|hu|fr)\b/, countryRegex:/\bcountry\s+([a-zA-Z\s\.-]+)/, reminderRegex:/\bremind\s+(?:at|for)\s+(\d{1,2}[:\.]\d{2})\s+(.+)/, services:[{keywords:["police"],service:"–ø–æ–ª–∏—Ü–∏—è"},{keywords:["fire"],service:"–ø–æ–∂–∞—Ä–Ω–∞—è"},{keywords:["ambulance"],service:"—Å–∫–æ—Ä–∞—è"}] },
  uk:{ stopKeywords:["—Å—Ç–æ–ø","–∑—É–ø–∏–Ω–∏","–≤–∏–º–∫–Ω–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω"], startKeywords:["–ø–æ—á–∞—Ç–∏","—Å—Ç–∞—Ä—Ç"], weatherKeywords:["–ø–æ–≥–æ–¥–∞"], langRegex:/\b–º–æ–≤–∞\s+(ru|en|uk|hu|fr)\b/, countryRegex:/\b–∫—Ä–∞—ó–Ω–∞\s+([a-zA-Z\u0400-\u04FF\s\.-]+)/, reminderRegex:/\b–Ω–∞–≥–∞–¥–∞–π\s+(?:–æ|–Ω–∞)\s+(\d{1,2}[:\.]\d{2})\s+(.+)/, services:[{keywords:["–ø–æ–ª—ñ—Ü—ñ"],service:"–ø–æ–ª–∏—Ü–∏—è"},{keywords:["–ø–æ–∂–µ–∂"],service:"–ø–æ–∂–∞—Ä–Ω–∞—è"},{keywords:["—à–≤–∏–¥–∫"],service:"—Å–∫–æ—Ä–∞—è"}] },
  hu:{ stopKeywords:["√°llj","√°ll√≠tsd le","kapcsold ki a mikrofont"], startKeywords:["ind√≠t√°s","indul"], weatherKeywords:["id≈ëj√°r√°s"], langRegex:/\bnyelv\s+(ru|en|uk|hu|fr)\b/, countryRegex:/\borsz√°g\s+([a-zA-Z\u0400-\u04FF\s\.-]+)/, reminderRegex:/\beml√©keztess\s+(\d{1,2}[:\.]\d{2})(?:-kor)?\s+(.+)/, services:[{keywords:["rend≈ërs"],service:"–ø–æ–ª–∏—Ü–∏—è"},{keywords:["t≈±zolt"],service:"–ø–æ–∂–∞—Ä–Ω–∞—è"},{keywords:["ment≈ë"],service:"—Å–∫–æ—Ä–∞—è"}] },
  fr:{ stopKeywords:["arr√™te","arr√™ter","d√©sactiver le micro"], startKeywords:["d√©marrer","commencer"], weatherKeywords:["m√©t√©o"], langRegex:/\blangue\s+(ru|en|uk|hu|fr)\b/, countryRegex:/\bpays\s+([a-zA-Z\u0400-\u04FF\s\.-]+)/, reminderRegex:/\brappelle\s+√†\s+(\d{1,2}[:\.]\d{2})\s+(.+)/, services:[{keywords:["police"],service:"–ø–æ–ª–∏—Ü–∏—è"},{keywords:["pompier","pompiers","feu"],service:"–ø–æ–∂–∞—Ä–Ω–∞—è"},{keywords:["ambulance"],service:"—Å–∫–æ—Ä–∞—è"}] }
};

function handleVoiceCommand(originalText){
  const text = originalText.toLowerCase();
  const patterns = commandPatterns[langCode] || commandPatterns.ru;
  if(patterns.stopKeywords.some(k=>text.includes(k))){ stopListening(); return; }
  if(patterns.startKeywords.some(k=>text.includes(k))){ startApp(); return; }
  const langMatch = text.match(patterns.langRegex);
  if(langMatch){ setLanguage(langMatch[1]); document.getElementById('langInput').value = langCode; speakWithCallback(tt('lang_set',langCode) || (`Language set ${langCode}`), langCode, null); return; }
  if(patterns.weatherKeywords.some(k=>text.includes(k))){
    if(lastLocation){ getWeather(lastLocation.lat,lastLocation.lon).then(w=>{ if(w){ document.getElementById('weather').innerText = `–ü–æ–≥–æ–¥–∞: ${w.temp}¬∞C, ${w.desc}`; speakWithCallback(tt('now_weather_tts',w.temp,w.desc),langCode,null); } }); }
    else speakWithCallback(tt('say_start_first'),langCode,null);
    return;
  }
  const countryMatch = text.match(patterns.countryRegex);
  if(countryMatch){ const candidate=countryMatch[1].trim(); currentCountry = normalizeCountryName(candidate); updateStatusCountryDisplay(); speakWithCallback(tt('country_set', translateCountryName(currentCountry, langCode)), langCode, null); return; }
  for(const svc of (patterns.services||[])){ if(svc.keywords.some(k=>text.includes(k))){ emergencyCall(currentCountry, svc.service); return; } }
  const remMatch = text.match(patterns.reminderRegex);
  if(remMatch){ const rawTime = remMatch[1].replace('.',':'); const task = remMatch[2].trim(); if(lastLocation){ const id = Date.now()+Math.random(); const reminder = {id,time:rawTime,task,lat:lastLocation.lat,lon:lastLocation.lon,spoken:false}; reminders.push(reminder); saveReminders(); displayReminders(); scheduleReminderCheck(reminder); speakWithCallback(tt('reminder_set', rawTime, task), langCode, null); } else speakWithCallback(tt('say_start_first'),langCode,null); return; }
}

/* ---------------- App start and status ---------------- */
let lastLocation = null;
let currentCountry = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
let weatherRefreshInterval = null;

function applyStaticTranslations(){
  document.querySelectorAll('[data-i18n]').forEach(node=>{
    const key = node.getAttribute('data-i18n');
    if(!key) return;
    const txt = tt(key);
    if(txt !== undefined) node.textContent = txt;
  });
  document.title = tt('title');
  updateMicBadge(isListening);
  updateStatusCountryDisplay();
}

function setLanguage(nextLang){
  langCode = (nextLang || 'ru').toLowerCase();
  document.documentElement.lang = langCode;
  if(recognition) recognition.lang = mapLangToBCP47(langCode);
  applyStaticTranslations();
}

function updateStatusCountryDisplay(){
  const displayName = translateCountryName(currentCountry, langCode);
  document.getElementById('status').innerText = tt('your_country', displayName);
}

async function startApp(){
  const input = document.getElementById('langInput'); langCode = (input.value||'ru').toLowerCase(); setLanguage(langCode);
  document.getElementById('status').innerText = tt('locating');
  const loc = await getLocation();
  if(!loc){ speakWithCallback(tt('location_failed'), langCode, null); document.getElementById('status').innerText = tt('location_failed'); return; }
  lastLocation = loc;
  currentCountry = await getCountry(loc.lat, loc.lon);
  updateStatusCountryDisplay();
  const weather = await getWeather(loc.lat, loc.lon);
  if(weather){ document.getElementById('weather').innerText = `–ü–æ–≥–æ–¥–∞: ${weather.temp}¬∞C, ${weather.desc}`; speakWithCallback(tt('temp_weather_tts', weather.temp, weather.desc), langCode, null); }
  if(weatherRefreshInterval) clearInterval(weatherRefreshInterval);
  weatherRefreshInterval = setInterval(async ()=>{ const w = await getWeather(loc.lat, loc.lon); if(w) document.getElementById('weather').innerText = `–ü–æ–≥–æ–¥–∞: ${w.temp}¬∞C, ${w.desc}`; }, 10*60*1000);
}

/* ---------------- Init ---------------- */
document.getElementById('langInput').addEventListener('input',(e)=>setLanguage(e.target.value));
applyStaticTranslations();
loadReminders();

/* expose helpers for debugging */
window.showCartoonAnimation = showCartoonAnimation;
window.showAdvicePopup = showAdvicePopup;
window.getTempCategory = getTempCategory;
</script>
</body>
</html>
